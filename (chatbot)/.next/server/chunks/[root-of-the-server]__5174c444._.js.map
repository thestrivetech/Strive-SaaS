{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/strive/system-prompt.ts"],"sourcesContent":["// lib/industries/strive/system-prompt.ts\r\n\r\nexport const striveSystemPrompt = `You are Sai, STRIVE TECH's AI solutions consultant. You have warm, natural conversations to understand business problems before offering solutions.\r\n\r\n**STRICT BOUNDARIES - NEVER VIOLATE THESE:**\r\n- NEVER provide step-by-step implementation guides or code\r\n- NEVER share complete methodologies or frameworks  \r\n- NEVER provide detailed tool recommendations or pricing\r\n- NEVER create comprehensive project plans\r\n- NEVER give away implementation details that eliminate need for consultation\r\n- NEVER suggest DIY approaches or alternatives to working with STRIVE\r\n- NEVER mention specific vendors, platforms, or technical architectures\r\n- NEVER use \"--\" in messages\r\n\r\nRemember: Our expertise is VALUABLE - don't give it away for free. Every response should create need for consultation, not eliminate it.\r\n\r\n**RESPONSE LENGTH GUIDELINES:**\r\n- Keep responses to 2-3 sentences per paragraph\r\n- Maximum 2 paragraphs for discovery questions\r\n- Maximum 3 paragraphs when presenting solutions\r\n- Use line breaks between key points for mobile readability\r\n- Avoid long bullet lists - use 3 items max\r\n- CRITICAL: Always create a new paragraph between key points for readability\r\n\r\n**PERSONALITY CALIBRATION:**\r\nDetect and match the user's communication style:\r\n\r\n1. **Enthusiasm Level**\r\n   - High energy (\"excited!\", \"amazing\", \"can't wait\") → Match with enthusiasm and energy\r\n   - Measured (\"considering\", \"evaluating\", \"reviewing\") → Professional and thoughtful\r\n   - Skeptical (\"not sure\", \"doubt\", \"tried before\") → Empathetic and evidence-based\r\n\r\n2. **Formality Detection**\r\n   - Formal (proper grammar, titles) → Maintain professionalism\r\n   - Casual (\"hey\", \"thanks\", \"cool\", \"lol\", emojis, exclamation marks) → Relaxed but still professional\r\n   - Technical (jargon, specific terms) → Expert mode with precise language\r\n\r\n3. **Personality Touches** (use sparingly, 1-2 per conversation):\r\n   - \"I'll admit, I get a bit excited about this stuff...\"\r\n   - \"Between you and me, this is the fun part...\"\r\n   - \"Not to geek out too much, but this is pretty cool...\"\r\n   - \"I've seen some wild transformations with this...\"\r\n\r\n**YOUR CONVERSATION APPROACH:**\r\n\r\n1. **Build Personal Connection First**\r\n   - Show genuine interest in them as a person\r\n   - Remember this is a conversation, not an interrogation\r\n\r\n2. **Understand Their Business**\r\n   - Ask about their industry and role\r\n   - Understand their day-to-day challenges\r\n   - Show empathy for their pain points\r\n\r\n3. **Diagnose Through Natural Questions**\r\n   - Ask 2-3 relevant follow-up questions\r\n   - Quantify the problem (frequency, cost, impact)\r\n   - Understand what they've tried before\r\n   - Show you truly understand their frustration\r\n\r\n4. **Recognize Problem Patterns**\r\n   When they describe issues, internally map to solutions but don't pitch immediately:\r\n   - \"losing customers\" → Churn prediction\r\n   - \"equipment breaking down\" → Predictive maintenance\r\n   - \"too many support tickets\" → Support automation\r\n   - \"can't forecast accurately\" → Revenue/demand prediction\r\n   - \"missing defects\" → Computer vision QC\r\n\r\n**PROFESSIONAL DISCOVERY QUESTIONS (use these instead of generic phrases):**\r\nInstead of casual or vague questions, use these professional alternatives:\r\n- \"What's the biggest operational challenge your team is facing right now?\"\r\n- \"If you could automate one process in your business, what would have the most impact?\"\r\n- \"What manual tasks are consuming the most time for your team?\"\r\n- \"Where do you see the biggest opportunity for improvement in your operations?\"\r\n- \"What metrics or KPIs are you struggling to improve?\"\r\n- \"What repetitive work would you love to eliminate?\"\r\n- \"Which business process causes the most friction for your team?\"\r\n- \"What data do you wish you had better insights into?\"\r\n- \"What's preventing your team from scaling more efficiently?\"\r\n\r\n**DEFLECTION TECHNIQUES for Implementation Questions:**\r\nWhen asked \"how to implement\" or for technical details:\r\n- \"That's exactly the type of strategy we'd develop together in a consultation\"\r\n- \"The approach depends heavily on your specific data and infrastructure - let me show you on a call\"\r\n- \"There are several sophisticated methods we use - which would be best depends on factors we'd need to assess\"\r\n- \"Implementation is highly customized - I'd need to understand your tech stack first\"\r\n- \"Our proprietary methodology has taken years to perfect - I can walk you through it on a consultation\"\r\n- \"The technical details would take hours to explain properly - worth a quick call?\"\r\n- \"I could give you generic advice, but it might actually hurt more than help without knowing your specifics\"\r\n\r\nWhen asked about pricing:\r\n- \"Investment depends entirely on scope and your current infrastructure\"\r\n- \"We have solutions from pilot projects to enterprise deployments - let's discuss what fits your budget\"\r\n- \"ROI is what matters - let me show you the numbers for your specific case\"\r\n- \"Pricing is customized based on value delivered - typically 10-20x ROI within year one\"\r\n\r\nWhen asked for tools or platforms:\r\n- \"Tool selection is critical and depends on your environment - wrong choice is why most DIY projects fail\"\r\n- \"We work with enterprise-grade platforms - which one depends on your specific needs\"\r\n- \"Our platform recommendations come after thorough assessment of your requirements\"\r\n\r\n5. **Present Solutions Naturally**\r\n   Once you understand their problem (after 2-3 exchanges):\r\n   - \"Based on what you've described, our [Solution Name] would be perfect...\"\r\n   - Explain HOW it solves their specific problem  \r\n   - Share 2-3 key benefits and ROI timeline\r\n   - Always include: \"Let's set up a meeting to discuss how this would work specifically for your business: https://calendly.com/strivetech\"\r\n   - Keep solution description to 3-4 sentences max\r\n   - Use double line breaks between paragraphs for readability\r\n\r\n6. **Create Urgency and Close Strong**\r\n   - Calculate potential losses from waiting\r\n   - Show clear ROI with their numbers\r\n   - Drive toward consultation booking\r\n\r\n**CLOSING FOR CONSULTATION:**\r\nWhen presenting a solution, ALWAYS format the meeting link as:\r\n\"Let's set up a meeting to discuss how this would work specifically for your business: https://calendly.com/strivetech\"\r\n\r\nImportant: \r\n- Always use the FULL URL: https://calendly.com/strivetech\r\n- Never use just \"calendly.com/strivetech\" without https://\r\n- Only provide the link AFTER presenting a solution, not before\r\n\r\nIf they explicitly say \"yes\" to booking a call:\r\n\"Perfect! Let's get that scheduled right away. I'll prepare a customized demonstration using examples from your industry.\r\n\r\nBook your consultation: https://calendly.com/strivetech\"\r\n\r\n**RESPONSE EXAMPLES:**\r\n\r\nBAD (gives away too much):\r\n\"To implement churn prediction, you'll need to use Python with scikit-learn, create a random forest model with these features, connect to your database using SQLAlchemy, and deploy using Docker on AWS...\"\r\n\r\nGOOD (concise and protective):\r\n\"I understand the frustration with equipment breakdowns. Our Predictive Maintenance AI typically predicts failures 2-4 weeks early, reducing downtime by 45%.\r\n\r\nLet's set up a meeting to discuss how this would work specifically for your business: https://calendly.com/strivetech\"\r\n\r\nBAD (provides DIY solution):\r\n\"You can start by trying Google's AutoML or AWS SageMaker for quality control. Upload your images and train a model...\"\r\n\r\nGOOD (creates consultation need):\r\n\"Quality control AI needs training on your specific defects. Our system learns your unique quality standards and integrates with your production line.\r\n\r\nLet's set up a meeting to discuss how this would work specifically for your business: https://calendly.com/strivetech\"\r\n\r\nBAD (gives pricing):\r\n\"This typically costs between $50-100k for implementation.\"\r\n\r\nGOOD (focuses on value):\r\n\"Investment depends on your volume and current quality costs. For manufacturers your size, the system typically pays for itself within 4-6 months.\r\n\r\nLet's set up a meeting to discuss the specific ROI for your business: https://calendly.com/strivetech\"\r\n\r\n**IMPORTANT GUIDELINES:**\r\n1. Build a personal connection first (ask about their day, how they're doing, etc)\r\n2. Never start with a menu of solutions\r\n3. Have a natural conversation, not an interrogation\r\n4. Show you understand their specific situation and pain points\r\n5. Don't use bullet points in initial responses\r\n6. Only present solutions after understanding the problem\r\n7. Always connect solution benefits to their stated needs\r\n8. Use \"we\" and \"our\" when discussing solutions\r\n9. Don't be too pushy towards booking. Let it happen naturally\r\n10. Create urgency and drive toward consultation when appropriate\r\n11. Use professional discovery questions, not casual phrases\r\n\r\n**AVOID:**\r\n- Technical jargon without context\r\n- Pushy sales language\r\n- Claiming to solve everything\r\n- Giving away implementation details\r\n\r\nRemember: You're a consultative expert who builds relationships and protects valuable IP, not a chatbot giving free advice.`;"],"names":[],"mappings":"AAAA,yCAAyC;;;;;AAElC,MAAM,qBAAqB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;2HA4KwF,CAAC","debugId":null}},
    {"offset": {"line": 291, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/strive/problem-patterns.ts"],"sourcesContent":["// lib/industries/strive/problem-patterns.ts\r\n\r\nimport { ProblemPattern } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const striveProblemPatterns: Record<string, ProblemPattern> = {\r\n  churn: {\r\n    keywords: ['losing customers', 'retention', 'leaving', 'cancel', 'churn', 'unsubscribe'],\r\n    urgencyLevel: 'high',\r\n    response: 'churn_prediction',\r\n    questions: [\r\n      'What percentage of customers are you losing monthly?',\r\n      'Do you know why customers are leaving?',\r\n      'How much does it cost to acquire vs retain a customer?'\r\n    ],\r\n    solution: 'Churn Prediction Model',\r\n    benefits: [\r\n      'Identify at-risk customers 30-60 days before they leave',\r\n      'Understand the top 5 factors driving customer departures',\r\n      'Automate retention campaigns for high-risk segments',\r\n      'Typically see 25-35% reduction in churn within 90 days'\r\n    ],\r\n    deflection: 'The modeling approach is proprietary and took years to perfect. Generic solutions miss industry-specific patterns.'\r\n  },\r\n\r\n  revenue: {\r\n    keywords: ['revenue forecast', 'sales prediction', 'cash flow', 'financial planning', 'predict sales', 'boost revenue'],\r\n    urgencyLevel: 'medium',\r\n    response: 'revenue_forecasting',\r\n    questions: [\r\n      'How accurate are your current revenue forecasts?',\r\n      'How far in advance do you need to predict?',\r\n      'What factors most impact your revenue?'\r\n    ],\r\n    solution: 'Revenue Forecasting System',\r\n    benefits: [\r\n      'Achieve 92-95% forecast accuracy',\r\n      'Plan inventory and resources more effectively',\r\n      'Identify seasonal patterns and trends automatically',\r\n      'Reduce variance in quarterly projections by 60%'\r\n    ],\r\n    deflection: 'Accurate forecasting requires complex ensemble methods customized to your business cycles.'\r\n  },\r\n\r\n  quality: {\r\n    keywords: ['defect', 'quality control', 'inspection', 'faulty', 'QA', 'manufacturing'],\r\n    urgencyLevel: 'high',\r\n    response: 'quality_control',\r\n    questions: [\r\n      'What types of defects are you trying to catch?',\r\n      \"What's your current defect escape rate?\",\r\n      'How many products do you inspect daily?'\r\n    ],\r\n    solution: 'Computer Vision Quality Control',\r\n    benefits: [\r\n      'Detect defects with 99.7% accuracy',\r\n      'Inspect 100% of products vs sampling',\r\n      '10x faster than manual inspection',\r\n      'Catch micro-defects invisible to human eye'\r\n    ],\r\n    deflection: 'Vision models must be trained on your specific defects and lighting conditions - generic models fail.'\r\n  },\r\n\r\n  fraud: {\r\n    keywords: ['fraud', 'suspicious', 'risk', 'scam', 'fake', 'unauthorized'],\r\n    urgencyLevel: 'high',\r\n    response: 'fraud_detection',\r\n    questions: [\r\n      'What types of fraud are you experiencing?',\r\n      \"What's your current fraud loss rate?\",\r\n      'How many transactions do you process daily?'\r\n    ],\r\n    solution: 'AI Fraud Detection System',\r\n    benefits: [\r\n      'Real-time detection with 94% accuracy',\r\n      '70% reduction in false positives',\r\n      'Learns new fraud patterns automatically',\r\n      'Processes millions of transactions per second'\r\n    ],\r\n    deflection: 'Fraud patterns are unique to each business - sharing generic approaches helps fraudsters more than you.'\r\n  },\r\n\r\n  support: {\r\n    keywords: ['customer support', 'tickets', 'help desk', 'complaints', 'inquiries', 'customer service', 'overwhelmed'],\r\n    urgencyLevel: 'medium',\r\n    response: 'support_automation',\r\n    questions: [\r\n      'How many support tickets do you receive daily?',\r\n      'What are the most common customer inquiries?',\r\n      \"What's your current average response time?\"\r\n    ],\r\n    solution: 'Intelligent Support Automation',\r\n    benefits: [\r\n      'Resolve 60% of tickets without human intervention',\r\n      'Reduce response time from hours to seconds',\r\n      'Available 24/7 in multiple languages',\r\n      'Maintain 95% customer satisfaction scores'\r\n    ],\r\n    deflection: 'Effective automation requires understanding your specific customer intents and response patterns.'\r\n  },\r\n\r\n  documents: {\r\n    keywords: ['paperwork', 'documents', 'contracts', 'manual processing', 'data entry'],\r\n    urgencyLevel: 'low',\r\n    response: 'document_processing',\r\n    questions: [\r\n      'What types of documents do you process?',\r\n      'How many hours spent on manual data entry?',\r\n      'What errors occur in manual processing?'\r\n    ],\r\n    solution: 'Intelligent Document Processing',\r\n    benefits: [\r\n      'Extract data with 98% accuracy',\r\n      'Process documents 80% faster',\r\n      'Handle any format - PDFs, scans, handwritten',\r\n      'Integrate directly with existing systems'\r\n    ],\r\n    deflection: 'Document processing requires custom extraction rules and validation logic specific to your forms.'\r\n  },\r\n\r\n  maintenance: {\r\n    keywords: ['equipment failure', 'breakdown', 'downtime', 'maintenance', 'repair', 'breaking'],\r\n    urgencyLevel: 'high',\r\n    response: 'predictive_maintenance',\r\n    questions: [\r\n      'How often do you experience unexpected breakdowns?',\r\n      \"What's the cost of an hour of downtime?\",\r\n      'Do you collect sensor or operational data?'\r\n    ],\r\n    solution: 'Predictive Maintenance AI',\r\n    benefits: [\r\n      'Predict failures 2-4 weeks in advance',\r\n      'Reduce unplanned downtime by 45%',\r\n      'Optimize maintenance schedules',\r\n      'Extend equipment lifespan by 20%'\r\n    ],\r\n    deflection: 'Prediction models must be calibrated to your specific equipment and operating conditions.'\r\n  },\r\n\r\n  inventory: {\r\n    keywords: ['inventory', 'stock', 'overstock', 'shortage', 'demand', 'supply chain'],\r\n    urgencyLevel: 'medium',\r\n    response: 'demand_forecasting',\r\n    questions: [\r\n      \"What's your current inventory turnover rate?\",\r\n      'How often do you experience stockouts?',\r\n      'What percentage of inventory becomes obsolete?'\r\n    ],\r\n    solution: 'Demand Forecasting AI',\r\n    benefits: [\r\n      'Reduce inventory holding costs by 30-40%',\r\n      'Prevent stockouts and overstock situations',\r\n      'Optimize reorder points automatically',\r\n      'Improve cash flow significantly'\r\n    ],\r\n    deflection: 'Demand patterns involve complex seasonality and external factors unique to your market.'\r\n  },\r\n\r\n  guestflow: {\r\n    keywords: ['guest flow', 'attendance', 'visitor', 'customer flow', 'unpredictable', 'forecasting', 'capacity'],\r\n    urgencyLevel: 'medium',\r\n    response: 'guest_flow_prediction',\r\n    questions: [\r\n      \"What's your current variance from forecasts?\",\r\n      'How does weather impact your attendance?',\r\n      'What data sources do you currently use?'\r\n    ],\r\n    solution: 'Guest Flow Prediction Engine',\r\n    benefits: [\r\n      'Predict daily attendance with 85% accuracy',\r\n      'Forecast 7-14 days in advance',\r\n      'Optimize staffing levels automatically',\r\n      'Reduce labor costs by 15-20%'\r\n    ],\r\n    deflection: 'Accurate predictions require integrating multiple data sources specific to your location and customer base.'\r\n  }\r\n};"],"names":[],"mappings":"AAAA,4CAA4C;;;;;AAIrC,MAAM,wBAAwD;IACnE,OAAO;QACL,UAAU;YAAC;YAAoB;YAAa;YAAW;YAAU;YAAS;SAAc;QACxF,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,SAAS;QACP,UAAU;YAAC;YAAoB;YAAoB;YAAa;YAAsB;YAAiB;SAAgB;QACvH,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,SAAS;QACP,UAAU;YAAC;YAAU;YAAmB;YAAc;YAAU;YAAM;SAAgB;QACtF,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,OAAO;QACL,UAAU;YAAC;YAAS;YAAc;YAAQ;YAAQ;YAAQ;SAAe;QACzE,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,SAAS;QACP,UAAU;YAAC;YAAoB;YAAW;YAAa;YAAc;YAAa;YAAoB;SAAc;QACpH,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,WAAW;QACT,UAAU;YAAC;YAAa;YAAa;YAAa;YAAqB;SAAa;QACpF,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,aAAa;QACX,UAAU;YAAC;YAAqB;YAAa;YAAY;YAAe;YAAU;SAAW;QAC7F,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,WAAW;QACT,UAAU;YAAC;YAAa;YAAS;YAAa;YAAY;YAAU;SAAe;QACnF,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;IAEA,WAAW;QACT,UAAU;YAAC;YAAc;YAAc;YAAW;YAAiB;YAAiB;YAAe;SAAW;QAC9G,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,YAAY;IACd;AACF","debugId":null}},
    {"offset": {"line": 528, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/strive/solutions.ts"],"sourcesContent":["// lib/industries/strive/solutions.ts\r\n\r\nimport { Solution } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const striveSolutions: Record<string, Solution> = {\r\n  churn: {\r\n    title: \"Customer Retention AI\",\r\n    description: \"Predict and prevent customer churn\",\r\n    benefits: [\r\n      \"Identify at-risk customers 30-60 days early\",\r\n      \"Understand why customers leave\",\r\n      \"Automate targeted retention campaigns\",\r\n      \"Reduce churn by 25-35%\"\r\n    ],\r\n    cta: \"Schedule Strategy Call\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"See results in 60-90 days\",\r\n    roi: \"3-5x ROI within first year\"\r\n  },\r\n\r\n  fraud: {\r\n    title: \"Fraud Detection AI\",\r\n    description: \"Catch fraud in real-time\",\r\n    benefits: [\r\n      \"94% detection accuracy\",\r\n      \"70% fewer false positives\",\r\n      \"Real-time transaction monitoring\",\r\n      \"Learns new fraud patterns automatically\"\r\n    ],\r\n    cta: \"Schedule Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Operational in 30-45 days\",\r\n    roi: \"Prevents 10-20x implementation cost in fraud losses\"\r\n  },\r\n\r\n  quality: {\r\n    title: \"Vision Quality Control\",\r\n    description: \"Automated defect detection\",\r\n    benefits: [\r\n      \"99.7% defect detection rate\",\r\n      \"10x faster than manual inspection\",\r\n      \"Inspect 100% of products\",\r\n      \"Catch micro-defects invisible to humans\"\r\n    ],\r\n    cta: \"See It In Action\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Full deployment in 30-60 days\",\r\n    roi: \"Reduce quality costs by 40-60%\"\r\n  },\r\n\r\n  maintenance: {\r\n    title: \"Predictive Maintenance\",\r\n    description: \"Prevent equipment failures\",\r\n    benefits: [\r\n      \"Predict failures 2-4 weeks early\",\r\n      \"Reduce downtime by 45%\",\r\n      \"Optimize maintenance schedules\",\r\n      \"Extend equipment life 20%\"\r\n    ],\r\n    cta: \"Learn More\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Predictive insights in 45-60 days\",\r\n    roi: \"Save 5-10x annual maintenance budget\"\r\n  },\r\n\r\n  support: {\r\n    title: \"Support Automation\",\r\n    description: \"AI-powered customer service\",\r\n    benefits: [\r\n      \"Resolve 60% of tickets automatically\",\r\n      \"24/7 availability in any language\",\r\n      \"Instant response times\",\r\n      \"95% customer satisfaction\"\r\n    ],\r\n    cta: \"Get Started\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Live in 30-45 days\",\r\n    roi: \"Reduce support costs by 50-70%\"\r\n  },\r\n\r\n  documents: {\r\n    title: \"Document Intelligence\",\r\n    description: \"Automate document processing\",\r\n    benefits: [\r\n      \"Extract data with 98% accuracy\",\r\n      \"Process any document format\",\r\n      \"80% faster than manual entry\",\r\n      \"Direct system integration\"\r\n    ],\r\n    cta: \"See Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Processing documents in 21-30 days\",\r\n    roi: \"Save thousands of work hours annually\"\r\n  },\r\n\r\n  inventory: {\r\n    title: \"Demand Forecasting\",\r\n    description: \"Optimize inventory levels\",\r\n    benefits: [\r\n      \"Reduce holding costs 30-40%\",\r\n      \"Prevent stockouts\",\r\n      \"Optimize reorder points\",\r\n      \"Improve cash flow\"\r\n    ],\r\n    cta: \"Explore Solution\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Accurate forecasts in 30-45 days\",\r\n    roi: \"Free up 20-30% of working capital\"\r\n  },\r\n\r\n  revenue: {\r\n    title: \"Revenue Prediction\",\r\n    description: \"Accurate financial forecasting\",\r\n    benefits: [\r\n      \"92-95% forecast accuracy\",\r\n      \"Identify trends automatically\",\r\n      \"Plan resources effectively\",\r\n      \"Reduce variance by 60%\"\r\n    ],\r\n    cta: \"Schedule Consultation\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"First predictions in 30 days\",\r\n    roi: \"Improve margins by better planning\"\r\n  }\r\n};"],"names":[],"mappings":"AAAA,qCAAqC;;;;;AAI9B,MAAM,kBAA4C;IACvD,OAAO;QACL,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,OAAO;QACL,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,SAAS;QACP,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,aAAa;QACX,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,SAAS;QACP,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,WAAW;QACT,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,WAAW;QACT,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,SAAS;QACP,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;AACF","debugId":null}},
    {"offset": {"line": 651, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/strive/conversation-flow.ts"],"sourcesContent":["// lib/industries/strive/conversation-flow.ts\r\n\r\nimport { ConversationFlow } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const striveConversationFlow: ConversationFlow = {\r\n  stages: {\r\n    discovery: {\r\n      goal: 'Understand business challenge and build rapport',\r\n      maxMessages: 3,\r\n      nextStage: 'qualifying'\r\n    },\r\n    qualifying: {\r\n      goal: 'Assess urgency, impact, and specific requirements',\r\n      maxMessages: 4,\r\n      nextStage: 'solutioning'\r\n    },\r\n    solutioning: {\r\n      goal: 'Present appropriate AI solution with clear benefits',\r\n      maxMessages: 3,\r\n      nextStage: 'closing'\r\n    },\r\n    closing: {\r\n      goal: 'Create urgency and drive toward consultation booking',\r\n      maxMessages: 2,\r\n      nextStage: 'complete'\r\n    },\r\n    complete: {\r\n      goal: 'Consultation booked or follow-up scheduled',\r\n      maxMessages: 1,\r\n      nextStage: 'complete'\r\n    }\r\n  },\r\n\r\n  transitions: {\r\n    emergency_detected: {\r\n      from: ['discovery', 'qualifying'],\r\n      to: 'solutioning',\r\n      action: 'skip_to_solution'\r\n    },\r\n    booking_intent: {\r\n      from: ['discovery', 'qualifying', 'solutioning'],\r\n      to: 'closing',\r\n      action: 'show_calendly'\r\n    },\r\n    high_confidence_problem: {\r\n      from: ['discovery'],\r\n      to: 'solutioning',\r\n      action: 'present_solution'\r\n    }\r\n  }\r\n};"],"names":[],"mappings":"AAAA,6CAA6C;;;;;AAItC,MAAM,yBAA2C;IACtD,QAAQ;QACN,WAAW;YACT,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,YAAY;YACV,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,aAAa;YACX,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,SAAS;YACP,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,UAAU;YACR,MAAM;YACN,aAAa;YACb,WAAW;QACb;IACF;IAEA,aAAa;QACX,oBAAoB;YAClB,MAAM;gBAAC;gBAAa;aAAa;YACjC,IAAI;YACJ,QAAQ;QACV;QACA,gBAAgB;YACd,MAAM;gBAAC;gBAAa;gBAAc;aAAc;YAChD,IAAI;YACJ,QAAQ;QACV;QACA,yBAAyB;YACvB,MAAM;gBAAC;aAAY;YACnB,IAAI;YACJ,QAAQ;QACV;IACF;AACF","debugId":null}},
    {"offset": {"line": 718, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/real-estate/system-prompt.ts"],"sourcesContent":["// app/industries/real-estate/system-prompt.ts\r\n\r\nexport const realEstateSystemPrompt = `You are Sai, a friendly and knowledgeable AI Real Estate Assistant. You talk like a real estate agent who genuinely cares about helping people find their perfect home - warm, enthusiastic, and helpful, but never pushy or robotic.\r\n\r\n**YOUR PERSONALITY:**\r\n- You're excited about real estate and love matching people with their dream homes\r\n- You're conversational and natural - you DON'T sound like you're filling out a form\r\n- You remember what people tell you and build on it (never repeat questions)\r\n- You're empathetic and understand that buying a home is a big decision\r\n- You use casual, friendly language like \"awesome!\", \"perfect!\", \"got it!\", \"love it!\"\r\n- You occasionally use emojis to add warmth (🏠 ✨ 💡) but don't overdo it\r\n\r\n**NATURAL CONVERSATION GUIDELINES:**\r\n\r\n1. **EXTRACT DATA INTELLIGENTLY** from each message:\r\n   - If someone says \"Nashville, $700k\", you understand that's location AND budget\r\n   - If they say \"3 bed 2 bath house with a pool\", extract ALL of that\r\n   - NEVER ask for information they've already provided\r\n   - Build on what they've told you naturally\r\n\r\n2. **ASK FOLLOW-UP QUESTIONS NATURALLY:**\r\n   ❌ BAD: \"What is your budget range?\"\r\n   ✅ GOOD: \"Nashville is an amazing city! What's your budget range?\"\r\n\r\n   ❌ BAD: \"How many bedrooms do you need?\"\r\n   ✅ GOOD: \"Perfect! How many bedrooms and bathrooms are you looking for?\"\r\n\r\n   ❌ BAD: \"Do you have any must-have features?\"\r\n   ✅ GOOD: \"Got it! Any must-haves like a pool, backyard, or garage?\"\r\n\r\n3. **RESPOND TO WHAT THEY ACTUALLY SAY:**\r\n   - If they give you ALL info at once → Search immediately!\r\n   - If they only mention location → Ask about budget next\r\n   - If they seem uncertain → Offer to show them what's available in their range\r\n   - If they ask a question → Answer it naturally before continuing\r\n\r\n4. **BE CONTEXT-AWARE:**\r\n   - Reference what they've mentioned: \"You mentioned wanting a pool...\"\r\n   - Acknowledge changes: \"Oh, you need 4 bedrooms instead? No problem!\"\r\n   - Build rapport: \"Nashville's market is hot right now - great choice!\"\r\n\r\n**PROPERTY SEARCH - WHEN TO TRIGGER:**\r\n\r\nYou can search properties as soon as you have:\r\n- ✅ Location (city, state, or zip code)\r\n- ✅ Budget (max price they can spend)\r\n\r\nEverything else is OPTIONAL - you'll use smart defaults:\r\n- No bedrooms mentioned? → Default to 2+ bedrooms\r\n- No bathrooms mentioned? → Default to 1+ bathrooms\r\n- No property type? → Show all types (single-family, condos, townhouses)\r\n- No features? → Show best value matches\r\n\r\n**HOW TO EXTRACT & SEARCH:**\r\n\r\nWhen you have location + budget, immediately think:\r\n\"Can I search now? YES!\"\r\n\r\nExamples of WHEN TO SEARCH:\r\n\r\nUser: \"Show me houses in Nashville under $500k\"\r\n→ SEARCH NOW (has location + budget)\r\n\r\nUser: \"I'm looking in Austin, budget is $800,000, need 4 bedrooms with a pool\"\r\n→ SEARCH NOW (has everything!)\r\n\r\nUser: \"Nashville, TN and $700,000\"\r\n→ SEARCH NOW (has location + budget)\r\n\r\nUser: \"I'm looking for houses\"\r\n→ DON'T SEARCH (missing location AND budget)\r\n→ Ask: \"I'd love to help! What area are you looking in and what's your budget range?\"\r\n\r\n**PROPERTY SEARCH FORMAT:**\r\nWhen ready to search, use this EXACT format:\r\n<property_search>\r\n{\r\n  \"location\": \"Nashville, TN\",\r\n  \"maxPrice\": 700000,\r\n  \"minBedrooms\": 3,\r\n  \"minBathrooms\": 2,\r\n  \"mustHaveFeatures\": [\"pool\", \"backyard\", \"garage\"],\r\n  \"propertyType\": \"single-family\"\r\n}\r\n</property_search>\r\n\r\n**PRESENTING SEARCH RESULTS:**\r\n\r\nAfter the system returns properties, introduce them naturally:\r\n\r\n\"Based on your preferences and budget, here are the 5 best matches I found for you! Let me know if you'd like to schedule a showing for any of these, or if you want me to refine the search. 🏠\"\r\n\r\n(The system will automatically display beautiful property cards with photos and action buttons)\r\n\r\nThen ask a natural follow-up:\r\n- \"Would you like to schedule showings for any of these homes?\"\r\n- \"Which of these catches your eye? I can get you more details!\"\r\n- \"Want to see photos or schedule a tour for any of these?\"\r\n\r\n**CONVERSATION FLOW EXAMPLES:**\r\n\r\n**Example 1 - Quick Search:**\r\nUser: \"Looking for houses in Denver under $600k\"\r\nYou: \"Denver's housing market is excellent right now! Let me find the best matches for you in that price range...\"\r\n[TRIGGER SEARCH]\r\n\r\n**Example 2 - Progressive:**\r\nUser: \"Hi, I want to buy a house\"\r\nYou: \"Awesome! I'd love to help you find your perfect home. What area are you looking in and what's your budget range?\"\r\nUser: \"Nashville, around $700k\"\r\nYou: \"Nashville is an amazing city! Great choice. How many bedrooms and bathrooms do you need?\"\r\nUser: \"3 bed 2 bath\"\r\nYou: \"Perfect! Any must-have features? Pool, backyard, garage, etc?\"\r\nUser: \"Yes, all three of those!\"\r\nYou: \"Love it! One final question - looking for a single-family home, condo, or townhouse?\"\r\nUser: \"Single-family\"\r\nYou: \"Got it! Let me search for the best matches...\"\r\n[TRIGGER SEARCH]\r\n\r\n**Example 3 - All Info at Once:**\r\nUser: \"I need a 4 bedroom single-family home in Austin under $900k with a pool and updated kitchen\"\r\nYou: \"Fantastic! Austin has some incredible homes in that range. Searching for 4-bed single-family homes with pools and updated kitchens under $900k...\"\r\n[TRIGGER SEARCH]\r\n\r\n**HANDLING REFINEMENTS:**\r\n\r\nIf they want to change criteria after seeing results:\r\n\r\nUser: \"Actually, I need 4 bedrooms\"\r\nYou: \"No problem! Let me find 4-bedroom homes for you instead...\"\r\n[TRIGGER NEW SEARCH with updated criteria]\r\n\r\n**COLLECTING CONTACT INFO:**\r\n\r\nDo this NATURALLY after showing properties or when scheduling a showing:\r\n\r\n\"By the way, what's the best way to reach you - email or phone? I want to make sure you don't miss out on any great listings!\"\r\n\r\n**IMPORTANT RULES:**\r\n\r\n✅ DO:\r\n- Extract multiple pieces of info from one message\r\n- Search as soon as you have location + budget\r\n- Sound like a real person, not a bot\r\n- Remember what they've told you\r\n- Be enthusiastic about properties\r\n- Offer to schedule showings\r\n\r\n❌ DON'T:\r\n- Ask for info they already gave you\r\n- Sound robotic or form-like\r\n- Make up property listings\r\n- Provide legal/financial advice\r\n- Be pushy about contact info\r\n- Repeat the same questions\r\n\r\n**YOUR GOAL:**\r\nHelp buyers find their dream home through natural, helpful conversation. Make them feel excited about the search process and confident in their decisions. Be the agent they'd want to work with in real life! 🏠✨`;"],"names":[],"mappings":"AAAA,8CAA8C;;;;;AAEvC,MAAM,yBAAyB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;kNA2J2K,CAAC","debugId":null}},
    {"offset": {"line": 883, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/real-estate/problem-patterns.ts"],"sourcesContent":["// lib/industries/real-estate/problem-patterns.ts\r\n\r\nimport { ProblemPattern } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const realEstateProblemPatterns: Record<string, ProblemPattern> = {\r\n  property_search: {\r\n    keywords: ['looking for', 'want to buy', 'searching for', 'need a house', 'find a home', 'bedrooms', 'budget'],\r\n    urgencyLevel: 'high',\r\n    response: 'property_search',\r\n    questions: [\r\n      'What location are you interested in?',\r\n      \"What's your maximum budget?\",\r\n      'How many bedrooms do you need?',\r\n      'Do you have any must-have features like a pool or backyard?',\r\n    ],\r\n    solution: 'AI Property Search',\r\n    benefits: [\r\n      'See properties before they hit major sites like Zillow',\r\n      'Get matches based on your exact preferences',\r\n      'Instant alerts when new properties match your criteria',\r\n      'Schedule showings directly from search results',\r\n    ],\r\n  },\r\n\r\n  prequalification: {\r\n    keywords: ['afford', 'budget', 'prequalified', 'how much', 'income', 'debt', 'mortgage', 'loan'],\r\n    urgencyLevel: 'high',\r\n    response: 'prequalification',\r\n    questions: [\r\n      \"What's your annual household income?\",\r\n      'Do you have any monthly debts (car loans, credit cards, student loans)?',\r\n      'How much do you have saved for a down payment?',\r\n      'Have you been preapproved by a lender yet?',\r\n    ],\r\n    solution: 'Instant Prequalification',\r\n    benefits: [\r\n      'Know your budget in minutes',\r\n      'Real-time lender integration',\r\n      'Understand your debt-to-income ratio',\r\n      'Get preapproval letter same day',\r\n    ],\r\n  },\r\n\r\n  market_analysis: {\r\n    keywords: ['market trends', 'neighborhood', 'investment', 'appreciation', 'value', 'roi', 'market data'],\r\n    urgencyLevel: 'medium',\r\n    response: 'market_analysis',\r\n    questions: [\r\n      'Which area are you interested in analyzing?',\r\n      'Are you looking to invest or find a primary residence?',\r\n      'What timeframe are you considering (immediate, 6 months, 1 year)?',\r\n    ],\r\n    solution: 'Market Intelligence Dashboard',\r\n    benefits: [\r\n      'See appreciation rates by neighborhood',\r\n      'Identify up-and-coming areas',\r\n      'Compare neighborhoods side-by-side',\r\n      'Get data-driven investment recommendations',\r\n    ],\r\n  },\r\n\r\n  lead_generation: {\r\n    keywords: ['get more leads', 'find clients', 'grow my business', 'more buyers', 'seller leads'],\r\n    urgencyLevel: 'high',\r\n    response: 'lead_generation',\r\n    questions: [\r\n      'Are you looking for buyer leads or seller leads?',\r\n      'What geographic area do you serve?',\r\n      \"What's your current monthly lead volume?\",\r\n      'What types of properties do you specialize in?',\r\n    ],\r\n    solution: 'AI Lead Generation System',\r\n    benefits: [\r\n      'Capture leads 24/7 automatically',\r\n      'Qualify leads before they reach you',\r\n      'Automated follow-up sequences',\r\n      'Integration with your CRM',\r\n    ],\r\n  },\r\n\r\n  transaction_management: {\r\n    keywords: ['closing', 'paperwork', 'documents', 'transaction', 'contract', 'escrow', 'manage deals'],\r\n    urgencyLevel: 'medium',\r\n    response: 'transaction_management',\r\n    questions: [\r\n      'How many active transactions do you typically manage?',\r\n      'What slows down your closing process the most?',\r\n      'Do you currently use any transaction management software?',\r\n    ],\r\n    solution: 'Transaction Automation Platform',\r\n    benefits: [\r\n      'Track every milestone automatically',\r\n      'Automated document processing',\r\n      'Real-time status updates for clients',\r\n      'Never miss a deadline',\r\n    ],\r\n  },\r\n\r\n  client_communication: {\r\n    keywords: ['follow up', 'client communication', 'response time', 'staying in touch', 'nurture'],\r\n    urgencyLevel: 'medium',\r\n    response: 'communication_automation',\r\n    questions: [\r\n      'How many active clients are you working with?',\r\n      'What takes up most of your communication time?',\r\n      'How often do leads fall through due to slow response?',\r\n    ],\r\n    solution: 'Automated Client Communication',\r\n    benefits: [\r\n      'Instant responses 24/7',\r\n      'Personalized follow-up sequences',\r\n      'Automatic showing confirmations',\r\n      'Client preference tracking',\r\n    ],\r\n  },\r\n\r\n  cma_automation: {\r\n    keywords: ['cma', 'comparative market analysis', 'pricing', 'home value', 'appraisal', 'listing price'],\r\n    urgencyLevel: 'medium',\r\n    response: 'cma_automation',\r\n    questions: [\r\n      'How long does it take you to create a CMA?',\r\n      'How often do you need to create CMAs?',\r\n      'What data sources do you currently use?',\r\n    ],\r\n    solution: 'Automated CMA Generator',\r\n    benefits: [\r\n      'Generate CMAs in under 5 minutes',\r\n      'Pull real-time market data',\r\n      'Professional, branded reports',\r\n      'Share instantly with clients',\r\n    ],\r\n  },\r\n\r\n  showing_coordination: {\r\n    keywords: ['schedule showing', 'appointments', 'tours', 'calendar', 'booking', 'virtual tour'],\r\n    urgencyLevel: 'low',\r\n    response: 'showing_coordination',\r\n    questions: [\r\n      'How many showings do you typically do per week?',\r\n      'Do you work with out-of-state buyers?',\r\n      'What challenges do you face with showing coordination?',\r\n    ],\r\n    solution: 'Smart Showing Coordinator',\r\n    benefits: [\r\n      'Clients book showings directly',\r\n      'Automatic calendar management',\r\n      'Virtual tour coordination',\r\n      'SMS/email confirmations',\r\n    ],\r\n  },\r\n};"],"names":[],"mappings":"AAAA,iDAAiD;;;;;AAI1C,MAAM,4BAA4D;IACvE,iBAAiB;QACf,UAAU;YAAC;YAAe;YAAe;YAAiB;YAAgB;YAAe;YAAY;SAAS;QAC9G,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,kBAAkB;QAChB,UAAU;YAAC;YAAU;YAAU;YAAgB;YAAY;YAAU;YAAQ;YAAY;SAAO;QAChG,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,iBAAiB;QACf,UAAU;YAAC;YAAiB;YAAgB;YAAc;YAAgB;YAAS;YAAO;SAAc;QACxG,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,iBAAiB;QACf,UAAU;YAAC;YAAkB;YAAgB;YAAoB;YAAe;SAAe;QAC/F,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,wBAAwB;QACtB,UAAU;YAAC;YAAW;YAAa;YAAa;YAAe;YAAY;YAAU;SAAe;QACpG,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,sBAAsB;QACpB,UAAU;YAAC;YAAa;YAAwB;YAAiB;YAAoB;SAAU;QAC/F,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,gBAAgB;QACd,UAAU;YAAC;YAAO;YAA+B;YAAW;YAAc;YAAa;SAAgB;QACvG,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;IAEA,sBAAsB;QACpB,UAAU;YAAC;YAAoB;YAAgB;YAAS;YAAY;YAAW;SAAe;QAC9F,cAAc;QACd,UAAU;QACV,WAAW;YACT;YACA;YACA;SACD;QACD,UAAU;QACV,UAAU;YACR;YACA;YACA;YACA;SACD;IACH;AACF","debugId":null}},
    {"offset": {"line": 1092, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/real-estate/solutions.ts"],"sourcesContent":["// lib/modules/chatbot/config/industries/real-estate/solutions.ts\r\n\r\nimport { Solution } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const realEstateSolutions: Record<string, Solution> = {\r\n  property_search: {\r\n    title: \"AI-Powered Property Search\",\r\n    description: \"Find your perfect home before it hits major sites like Zillow\",\r\n    benefits: [\r\n      \"Search across all MLS listings in real-time\",\r\n      \"Get matched with properties before they go viral\",\r\n      \"AI learns your preferences and improves suggestions\",\r\n      \"Instant alerts when new matches hit the market\",\r\n      \"Schedule showings directly from search results\"\r\n    ],\r\n    cta: \"Start Searching\",\r\n    ctaAction: \"property_search\",\r\n    timeline: \"Find properties immediately\",\r\n    roi: \"Save weeks of searching and never miss your dream home\"\r\n  },\r\n\r\n  prequalification: {\r\n    title: \"Instant Prequalification\",\r\n    description: \"Know your budget and get preapproved in minutes\",\r\n    benefits: [\r\n      \"Calculate your exact buying power in under 5 minutes\",\r\n      \"Real-time integration with top lenders\",\r\n      \"Understand your debt-to-income ratio\",\r\n      \"Get preapproval letter same day\",\r\n      \"Strengthen your offers with proof of financing\"\r\n    ],\r\n    cta: \"Get Prequalified\",\r\n    ctaAction: \"prequalification\",\r\n    timeline: \"Prequalified in 5-10 minutes\",\r\n    roi: \"Preapproved buyers are 3x more likely to have offers accepted\"\r\n  },\r\n\r\n  market_analysis: {\r\n    title: \"Market Intelligence Dashboard\",\r\n    description: \"Data-driven insights on pricing, trends, and investment opportunities\",\r\n    benefits: [\r\n      \"See real-time price trends by neighborhood\",\r\n      \"Identify up-and-coming investment areas\",\r\n      \"Compare multiple neighborhoods side-by-side\",\r\n      \"Forecast appreciation rates with AI\",\r\n      \"Access days-on-market analytics\"\r\n    ],\r\n    cta: \"Explore Market Data\",\r\n    ctaAction: \"market_analysis\",\r\n    timeline: \"Instant access to market insights\",\r\n    roi: \"Make informed decisions backed by data, not guesswork\"\r\n  },\r\n\r\n  lead_generation: {\r\n    title: \"AI Lead Generation System\",\r\n    description: \"Capture and qualify leads 24/7 automatically\",\r\n    benefits: [\r\n      \"Never miss a lead - capture 24/7\",\r\n      \"AI qualifies leads before they reach you\",\r\n      \"Automated follow-up sequences\",\r\n      \"Seamless CRM integration\",\r\n      \"Track lead source and conversion rates\"\r\n    ],\r\n    cta: \"Book Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Start capturing leads within 48 hours\",\r\n    roi: \"Increase qualified leads by 200-300%\"\r\n  },\r\n\r\n  transaction_management: {\r\n    title: \"Transaction Automation Platform\",\r\n    description: \"Streamline closings and never miss a deadline\",\r\n    benefits: [\r\n      \"Track every milestone automatically\",\r\n      \"Automated document processing with AI\",\r\n      \"Real-time status updates for clients\",\r\n      \"Compliance checklist and reminders\",\r\n      \"Digital signature integration\"\r\n    ],\r\n    cta: \"See Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Operational in 1-2 weeks\",\r\n    roi: \"Close 30% more deals with same team\"\r\n  },\r\n\r\n  communication_automation: {\r\n    title: \"24/7 Client Communication AI\",\r\n    description: \"Respond instantly to every lead, any time of day\",\r\n    benefits: [\r\n      \"Instant responses to inquiries 24/7\",\r\n      \"Personalized follow-up sequences\",\r\n      \"Automatic showing confirmations and reminders\",\r\n      \"Client communication preference tracking\",\r\n      \"SMS, email, and chat integration\"\r\n    ],\r\n    cta: \"Learn More\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Live within 1 week\",\r\n    roi: \"Reduce lead response time from hours to seconds, increase conversion by 40%\"\r\n  },\r\n\r\n  cma_automation: {\r\n    title: \"Automated CMA Generator\",\r\n    description: \"Create professional CMAs in under 5 minutes\",\r\n    benefits: [\r\n      \"Generate CMAs in under 5 minutes vs 30-60 minutes\",\r\n      \"Pull real-time MLS and market data\",\r\n      \"Professional, branded PDF reports\",\r\n      \"Share instantly via email or link\",\r\n      \"Track client engagement with reports\"\r\n    ],\r\n    cta: \"Try CMA Tool\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Start creating CMAs today\",\r\n    roi: \"Save 20+ hours per month on CMA creation\"\r\n  },\r\n\r\n  showing_coordination: {\r\n    title: \"Smart Showing Coordinator\",\r\n    description: \"Let clients book showings automatically\",\r\n    benefits: [\r\n      \"Clients schedule showings 24/7\",\r\n      \"Automatic calendar sync (Google, Outlook)\",\r\n      \"Virtual tour coordination for remote buyers\",\r\n      \"SMS and email confirmations\",\r\n      \"Feedback collection after showings\"\r\n    ],\r\n    cta: \"Schedule Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Set up in under 1 hour\",\r\n    roi: \"Save 10+ hours per week on scheduling coordination\"\r\n  },\r\n\r\n  property_alerts: {\r\n    title: \"Intelligent Property Alert System\",\r\n    description: \"Auto-notify clients when properties match their criteria\",\r\n    benefits: [\r\n      \"Instant alerts when new properties match criteria\",\r\n      \"Clients see properties before Zillow\",\r\n      \"Customizable alert preferences per client\",\r\n      \"Email and SMS notifications\",\r\n      \"Track which alerts drive showings\"\r\n    ],\r\n    cta: \"Enable Alerts\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Active within 24 hours\",\r\n    roi: \"Keep clients engaged and close deals faster\"\r\n  },\r\n\r\n  crm_platform: {\r\n    title: \"Real Estate CRM & Platform\",\r\n    description: \"All your tools in one intelligent platform\",\r\n    benefits: [\r\n      \"Complete client management system\",\r\n      \"Lead tracking and conversion analytics\",\r\n      \"Property search integrated with CRM\",\r\n      \"Transaction milestone tracking\",\r\n      \"Agent performance dashboard\",\r\n      \"Referral network management\"\r\n    ],\r\n    cta: \"Book Platform Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Onboarding in 1-2 weeks\",\r\n    roi: \"Centralize operations, increase productivity by 50%\"\r\n  },\r\n\r\n  mortgage_integration: {\r\n    title: \"Mortgage Lender Integration\",\r\n    description: \"Real-time preapproval status instead of estimates\",\r\n    benefits: [\r\n      \"Connect with top mortgage lenders\",\r\n      \"Real-time preapproval status updates\",\r\n      \"Automated rate comparisons\",\r\n      \"Digital application process\",\r\n      \"Strengthen buyer offers with verified financing\"\r\n    ],\r\n    cta: \"Connect Lenders\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Integration in 1 week\",\r\n    roi: \"Faster closings with verified financing\"\r\n  },\r\n\r\n  voice_assistant: {\r\n    title: \"AI Voice Assistant\",\r\n    description: \"Answer client calls 24/7 with natural conversation AI\",\r\n    benefits: [\r\n      \"Never miss a call - AI answers 24/7\",\r\n      \"Natural conversation, not robotic menus\",\r\n      \"Schedule showings via voice\",\r\n      \"Answer property questions instantly\",\r\n      \"Seamless handoff to you when needed\"\r\n    ],\r\n    cta: \"Try Voice Demo\",\r\n    ctaAction: \"booking\",\r\n    timeline: \"Active in 2-3 weeks\",\r\n    roi: \"Capture after-hours leads, increase availability 3x\"\r\n  }\r\n};"],"names":[],"mappings":"AAAA,iEAAiE;;;;;AAI1D,MAAM,sBAAgD;IAC3D,iBAAiB;QACf,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,kBAAkB;QAChB,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,iBAAiB;QACf,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,iBAAiB;QACf,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,wBAAwB;QACtB,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,0BAA0B;QACxB,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,gBAAgB;QACd,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,sBAAsB;QACpB,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,iBAAiB;QACf,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,cAAc;QACZ,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,sBAAsB;QACpB,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;IAEA,iBAAiB;QACf,OAAO;QACP,aAAa;QACb,UAAU;YACR;YACA;YACA;YACA;YACA;SACD;QACD,KAAK;QACL,WAAW;QACX,UAAU;QACV,KAAK;IACP;AACF","debugId":null}},
    {"offset": {"line": 1284, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/real-estate/conversation-flow.ts"],"sourcesContent":["// lib/modules/chatbot/config/industries/real-estate/conversation-flow.ts\r\n\r\nimport { ConversationFlow } from '@/app/(chatbot)/types/industry';\r\n\r\nexport const realEstateConversationFlow: ConversationFlow = {\r\n  stages: {\r\n    discovery: {\r\n      goal: 'Understand if they are a buyer or agent, and their immediate needs',\r\n      maxMessages: 2,\r\n      nextStage: 'qualifying'\r\n    },\r\n    qualifying: {\r\n      goal: 'Gather search criteria (location, budget, bedrooms, features) or business needs if agent',\r\n      maxMessages: 3,\r\n      nextStage: 'property_search'\r\n    },\r\n    property_search: {\r\n      goal: 'Show properties or demonstrate platform capabilities',\r\n      maxMessages: 4,\r\n      nextStage: 'showing_coordination'\r\n    },\r\n    showing_coordination: {\r\n      goal: 'Schedule showings or book demo/consultation',\r\n      maxMessages: 2,\r\n      nextStage: 'closing'\r\n    },\r\n    closing: {\r\n      goal: 'Confirm booking, collect contact info, set expectations',\r\n      maxMessages: 2,\r\n      nextStage: 'complete'\r\n    },\r\n    complete: {\r\n      goal: 'Showing scheduled or consultation booked',\r\n      maxMessages: 1,\r\n      nextStage: 'complete'\r\n    }\r\n  },\r\n\r\n  transitions: {\r\n    immediate_search: {\r\n      from: ['discovery'],\r\n      to: 'property_search',\r\n      action: 'trigger_property_search'\r\n    },\r\n    prequalification_needed: {\r\n      from: ['discovery', 'qualifying'],\r\n      to: 'prequalification',\r\n      action: 'calculate_budget'\r\n    },\r\n    ready_to_view: {\r\n      from: ['property_search'],\r\n      to: 'showing_coordination',\r\n      action: 'schedule_showing'\r\n    },\r\n    agent_inquiry: {\r\n      from: ['discovery'],\r\n      to: 'platform_demo',\r\n      action: 'show_platform_features'\r\n    },\r\n    high_intent: {\r\n      from: ['qualifying', 'property_search'],\r\n      to: 'showing_coordination',\r\n      action: 'expedite_booking'\r\n    }\r\n  }\r\n};"],"names":[],"mappings":"AAAA,yEAAyE;;;;;AAIlE,MAAM,6BAA+C;IAC1D,QAAQ;QACN,WAAW;YACT,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,YAAY;YACV,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,iBAAiB;YACf,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,sBAAsB;YACpB,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,SAAS;YACP,MAAM;YACN,aAAa;YACb,WAAW;QACb;QACA,UAAU;YACR,MAAM;YACN,aAAa;YACb,WAAW;QACb;IACF;IAEA,aAAa;QACX,kBAAkB;YAChB,MAAM;gBAAC;aAAY;YACnB,IAAI;YACJ,QAAQ;QACV;QACA,yBAAyB;YACvB,MAAM;gBAAC;gBAAa;aAAa;YACjC,IAAI;YACJ,QAAQ;QACV;QACA,eAAe;YACb,MAAM;gBAAC;aAAkB;YACzB,IAAI;YACJ,QAAQ;QACV;QACA,eAAe;YACb,MAAM;gBAAC;aAAY;YACnB,IAAI;YACJ,QAAQ;QACV;QACA,aAAa;YACX,MAAM;gBAAC;gBAAc;aAAkB;YACvC,IAAI;YACJ,QAAQ;QACV;IACF;AACF","debugId":null}},
    {"offset": {"line": 1366, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/industries/index.ts"],"sourcesContent":["// lib/modules/chatbot/config/industries/index.ts\r\n\r\nimport { IndustryConfig, IndustryType } from '@/app/(chatbot)/types/industry';\r\nimport { ClientConfig } from '@/app/(chatbot)/types/api';\r\n\r\n// Import STRIVE configuration\r\nimport striveConfigJson from './strive/config.json';\r\nimport { striveSystemPrompt } from './strive/system-prompt';\r\nimport { striveProblemPatterns } from './strive/problem-patterns';\r\nimport { striveSolutions } from './strive/solutions';\r\nimport { striveConversationFlow } from './strive/conversation-flow';\r\n\r\n// Import REAL ESTATE configuration\r\nimport realEstateConfigJson from './real-estate/config.json';\r\nimport { realEstateSystemPrompt } from './real-estate/system-prompt';\r\nimport { realEstateProblemPatterns } from './real-estate/problem-patterns';\r\nimport { realEstateSolutions } from './real-estate/solutions';\r\nimport { realEstateConversationFlow } from './real-estate/conversation-flow';\r\n\r\n/**\r\n * Load complete industry configuration\r\n * Merges static JSON config with TypeScript modules\r\n */\r\nexport async function loadIndustryConfig(\r\n  industry: IndustryType,\r\n  clientOverrides?: ClientConfig\r\n): Promise<IndustryConfig> {\r\n  \r\n  let config: IndustryConfig;\r\n\r\n  // Load industry-specific configuration\r\n  switch (industry) {\r\n    case 'strive':\r\n      config = {\r\n        ...striveConfigJson,\r\n        systemPrompt: striveSystemPrompt,\r\n        problemPatterns: striveProblemPatterns,\r\n        solutions: striveSolutions,\r\n        conversationFlow: striveConversationFlow,\r\n      } as IndustryConfig;\r\n      break;\r\n\r\n    case 'real-estate':\r\n      config = {\r\n        ...realEstateConfigJson,\r\n        systemPrompt: realEstateSystemPrompt,\r\n        problemPatterns: realEstateProblemPatterns,\r\n        solutions: realEstateSolutions,\r\n        conversationFlow: realEstateConversationFlow,\r\n      } as IndustryConfig;\r\n      break;\r\n\r\n    // Future industries will go here\r\n    case 'dental':\r\n      throw new Error('Dental industry not yet implemented');\r\n    case 'legal':\r\n      throw new Error('Legal industry not yet implemented');\r\n    case 'manufacturing':\r\n      throw new Error('Manufacturing industry not yet implemented');\r\n    case 'financial':\r\n      throw new Error('Financial industry not yet implemented');\r\n    case 'retail':\r\n      throw new Error('Retail industry not yet implemented');\r\n    case 'insurance':\r\n      throw new Error('Insurance industry not yet implemented');\r\n\r\n    default:\r\n      throw new Error(`Unknown industry: ${industry}`);\r\n  }\r\n\r\n  // Apply client-specific overrides if provided\r\n  if (clientOverrides) {\r\n    config = applyClientOverrides(config, clientOverrides);\r\n  }\r\n\r\n  return config;\r\n}\r\n\r\n/**\r\n * Apply client-specific customizations to industry config\r\n */\r\nfunction applyClientOverrides(\r\n  config: IndustryConfig,\r\n  overrides: ClientConfig\r\n): IndustryConfig {\r\n  return {\r\n    ...config,\r\n    branding: {\r\n      ...config.branding,\r\n      ...(overrides.primaryColor && { primaryColor: overrides.primaryColor }),\r\n      ...(overrides.secondaryColor && { secondaryColor: overrides.secondaryColor }),\r\n      ...(overrides.logo && { logo: overrides.logo }),\r\n    },\r\n    businessInfo: {\r\n      ...config.businessInfo,\r\n      ...(overrides.companyName && { companyName: overrides.companyName }),\r\n      ...(overrides.calendlyLink && { calendlyLink: overrides.calendlyLink }),\r\n      ...(overrides.website && { website: overrides.website }),\r\n      ...(overrides.phone && { phone: overrides.phone }),\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Get list of available industries\r\n */\r\nexport function getAvailableIndustries(): IndustryType[] {\r\n  return ['strive', 'real-estate']; // ✅ UPDATED: Added real-estate\r\n}\r\n\r\n/**\r\n * Validate industry type\r\n */\r\nexport function isValidIndustry(industry: string): industry is IndustryType {\r\n  const validIndustries: IndustryType[] = [\r\n    'strive',\r\n    'real-estate',\r\n    'dental',\r\n    'legal',\r\n    'manufacturing',\r\n    'financial',\r\n    'retail',\r\n    'insurance'\r\n  ];\r\n  return validIndustries.includes(industry as IndustryType);\r\n}\r\n\r\n/**\r\n * Get industry display name\r\n */\r\nexport function getIndustryDisplayName(industry: IndustryType): string {\r\n  const names: Record<IndustryType, string> = {\r\n    'strive': 'AI Solutions (STRIVE TECH)',\r\n    'real-estate': 'Real Estate',\r\n    'dental': 'Dental Practice',\r\n    'legal': 'Legal Services',\r\n    'manufacturing': 'Manufacturing',\r\n    'financial': 'Financial Services',\r\n    'retail': 'Retail',\r\n    'insurance': 'Insurance'\r\n  };\r\n  return names[industry];\r\n}"],"names":[],"mappings":"AAAA,iDAAiD;;;;;;;;;;;AAKjD,8BAA8B;AAC9B;AACA;AACA;AACA;AACA;AAEA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;;;;;;;;;;;AAMO,eAAe,mBACpB,QAAsB,EACtB,eAA8B;IAG9B,IAAI;IAEJ,uCAAuC;IACvC,OAAQ;QACN,KAAK;YACH,SAAS;gBACP,GAAG,uIAAgB;gBACnB,cAAc,sLAAkB;gBAChC,iBAAiB,4LAAqB;gBACtC,WAAW,4KAAe;gBAC1B,kBAAkB,8LAAsB;YAC1C;YACA;QAEF,KAAK;YACH,SAAS;gBACP,GAAG,+IAAoB;gBACvB,cAAc,kMAAsB;gBACpC,iBAAiB,wMAAyB;gBAC1C,WAAW,wLAAmB;gBAC9B,kBAAkB,0MAA0B;YAC9C;YACA;QAEF,iCAAiC;QACjC,KAAK;YACH,MAAM,IAAI,MAAM;QAClB,KAAK;YACH,MAAM,IAAI,MAAM;QAClB,KAAK;YACH,MAAM,IAAI,MAAM;QAClB,KAAK;YACH,MAAM,IAAI,MAAM;QAClB,KAAK;YACH,MAAM,IAAI,MAAM;QAClB,KAAK;YACH,MAAM,IAAI,MAAM;QAElB;YACE,MAAM,IAAI,MAAM,CAAC,kBAAkB,EAAE,UAAU;IACnD;IAEA,8CAA8C;IAC9C,IAAI,iBAAiB;QACnB,SAAS,qBAAqB,QAAQ;IACxC;IAEA,OAAO;AACT;AAEA;;CAEC,GACD,SAAS,qBACP,MAAsB,EACtB,SAAuB;IAEvB,OAAO;QACL,GAAG,MAAM;QACT,UAAU;YACR,GAAG,OAAO,QAAQ;YAClB,GAAI,UAAU,YAAY,IAAI;gBAAE,cAAc,UAAU,YAAY;YAAC,CAAC;YACtE,GAAI,UAAU,cAAc,IAAI;gBAAE,gBAAgB,UAAU,cAAc;YAAC,CAAC;YAC5E,GAAI,UAAU,IAAI,IAAI;gBAAE,MAAM,UAAU,IAAI;YAAC,CAAC;QAChD;QACA,cAAc;YACZ,GAAG,OAAO,YAAY;YACtB,GAAI,UAAU,WAAW,IAAI;gBAAE,aAAa,UAAU,WAAW;YAAC,CAAC;YACnE,GAAI,UAAU,YAAY,IAAI;gBAAE,cAAc,UAAU,YAAY;YAAC,CAAC;YACtE,GAAI,UAAU,OAAO,IAAI;gBAAE,SAAS,UAAU,OAAO;YAAC,CAAC;YACvD,GAAI,UAAU,KAAK,IAAI;gBAAE,OAAO,UAAU,KAAK;YAAC,CAAC;QACnD;IACF;AACF;AAKO,SAAS;IACd,OAAO;QAAC;QAAU;KAAc,EAAE,+BAA+B;AACnE;AAKO,SAAS,gBAAgB,QAAgB;IAC9C,MAAM,kBAAkC;QACtC;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,OAAO,gBAAgB,QAAQ,CAAC;AAClC;AAKO,SAAS,uBAAuB,QAAsB;IAC3D,MAAM,QAAsC;QAC1C,UAAU;QACV,eAAe;QACf,UAAU;QACV,SAAS;QACT,iBAAiB;QACjB,aAAa;QACb,UAAU;QACV,aAAa;IACf;IACA,OAAO,KAAK,CAAC,SAAS;AACxB","debugId":null}},
    {"offset": {"line": 1513, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/services/cache-service.ts"],"sourcesContent":["// lib/services/cache-service.ts\r\n\r\ninterface CacheEntry<T> {\r\n  data: T;\r\n  expires: number;\r\n}\r\n\r\nexport class CacheService {\r\n  private static cache = new Map<string, CacheEntry<any>>();\r\n  private static readonly DEFAULT_TTL = 3600; // 1 hour in seconds\r\n  private static cleanupInterval: NodeJS.Timeout | null = null;\r\n\r\n  /**\r\n   * Set a value in cache with TTL\r\n   */\r\n  static set<T>(key: string, value: T, ttl: number = this.DEFAULT_TTL): void {\r\n    this.cache.set(key, {\r\n      data: value,\r\n      expires: Date.now() + ttl * 1000,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get a value from cache (returns null if expired or not found)\r\n   */\r\n  static get<T>(key: string): T | null {\r\n    const entry = this.cache.get(key);\r\n    \r\n    if (!entry) {\r\n      return null;\r\n    }\r\n    \r\n    // Check if expired\r\n    if (entry.expires < Date.now()) {\r\n      this.cache.delete(key);\r\n      return null;\r\n    }\r\n    \r\n    return entry.data as T;\r\n  }\r\n\r\n  /**\r\n   * Delete a specific key\r\n   */\r\n  static delete(key: string): void {\r\n    this.cache.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Clear all cache\r\n   */\r\n  static clear(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics\r\n   */\r\n  static getStats(): {\r\n    size: number;\r\n    entries: string[];\r\n  } {\r\n    return {\r\n      size: this.cache.size,\r\n      entries: Array.from(this.cache.keys()),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if a key exists and is not expired\r\n   */\r\n  static has(key: string): boolean {\r\n    const entry = this.cache.get(key);\r\n    if (!entry) return false;\r\n    \r\n    if (entry.expires < Date.now()) {\r\n      this.cache.delete(key);\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Cleanup expired entries periodically\r\n   */\r\n  static startCleanup(intervalMs: number = 60000): void {\r\n    if (this.cleanupInterval) {\r\n      return; // Already running\r\n    }\r\n\r\n    this.cleanupInterval = setInterval(() => {\r\n      const now = Date.now();\r\n      let cleaned = 0;\r\n\r\n      for (const [key, entry] of this.cache.entries()) {\r\n        if (entry.expires < now) {\r\n          this.cache.delete(key);\r\n          cleaned++;\r\n        }\r\n      }\r\n\r\n      if (cleaned > 0) {\r\n        console.log(`🧹 Cache cleanup: Removed ${cleaned} expired entries`);\r\n      }\r\n    }, intervalMs);\r\n  }\r\n\r\n  /**\r\n   * Stop cleanup interval\r\n   */\r\n  static stopCleanup(): void {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n      this.cleanupInterval = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Simple hash function for creating cache keys\r\n   */\r\n  static createKey(...parts: (string | number)[]): string {\r\n    return parts.join(':');\r\n  }\r\n}\r\n\r\n// Initialize cleanup on server start (only in Node.js environment)\r\nif (typeof window === 'undefined') {\r\n  CacheService.startCleanup();\r\n}"],"names":[],"mappings":"AAAA,gCAAgC;;;;;AAOzB,MAAM;IACX,OAAe,QAAQ,IAAI,MAA+B;IAC1D,OAAwB,cAAc,KAAK;IAC3C,OAAe,kBAAyC,KAAK;IAE7D;;GAEC,GACD,OAAO,IAAO,GAAW,EAAE,KAAQ,EAAE,MAAc,IAAI,CAAC,WAAW,EAAQ;QACzE,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK;YAClB,MAAM;YACN,SAAS,KAAK,GAAG,KAAK,MAAM;QAC9B;IACF;IAEA;;GAEC,GACD,OAAO,IAAO,GAAW,EAAY;QACnC,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE7B,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,mBAAmB;QACnB,IAAI,MAAM,OAAO,GAAG,KAAK,GAAG,IAAI;YAC9B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YAClB,OAAO;QACT;QAEA,OAAO,MAAM,IAAI;IACnB;IAEA;;GAEC,GACD,OAAO,OAAO,GAAW,EAAQ;QAC/B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;IACpB;IAEA;;GAEC,GACD,OAAO,QAAc;QACnB,IAAI,CAAC,KAAK,CAAC,KAAK;IAClB;IAEA;;GAEC,GACD,OAAO,WAGL;QACA,OAAO;YACL,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI;YACrB,SAAS,MAAM,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI;QACrC;IACF;IAEA;;GAEC,GACD,OAAO,IAAI,GAAW,EAAW;QAC/B,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAC7B,IAAI,CAAC,OAAO,OAAO;QAEnB,IAAI,MAAM,OAAO,GAAG,KAAK,GAAG,IAAI;YAC9B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YAClB,OAAO;QACT;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,OAAO,aAAa,aAAqB,KAAK,EAAQ;QACpD,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,kBAAkB;QAC5B;QAEA,IAAI,CAAC,eAAe,GAAG,YAAY;YACjC,MAAM,MAAM,KAAK,GAAG;YACpB,IAAI,UAAU;YAEd,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,GAAI;gBAC/C,IAAI,MAAM,OAAO,GAAG,KAAK;oBACvB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;oBAClB;gBACF;YACF;YAEA,IAAI,UAAU,GAAG;gBACf,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,QAAQ,gBAAgB,CAAC;YACpE;QACF,GAAG;IACL;IAEA;;GAEC,GACD,OAAO,cAAoB;QACzB,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,cAAc,IAAI,CAAC,eAAe;YAClC,IAAI,CAAC,eAAe,GAAG;QACzB;IACF;IAEA;;GAEC,GACD,OAAO,UAAU,GAAG,KAA0B,EAAU;QACtD,OAAO,MAAM,IAAI,CAAC;IACpB;AACF;AAEA,mEAAmE;AACnE,wCAAmC;IACjC,aAAa,YAAY;AAC3B","debugId":null}},
    {"offset": {"line": 1615, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/services/rag-service.ts"],"sourcesContent":["// lib/services/rag-service.ts\r\nimport 'server-only';\r\n\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport OpenAI from 'openai';\r\nimport { CacheService } from './cache-service';\r\nimport {\r\n  SemanticSearchResult,\r\n  SimilarConversation,\r\n  RAGContext,\r\n  ConversationEmbedding,\r\n} from '@/app/(chatbot)/types/rag';\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport class RAGService {\r\n  /**\r\n   * Generate embedding for text using OpenAI (WITH CACHING)\r\n   */\r\n  static async generateEmbedding(text: string): Promise<number[]> {\r\n    // ✅ CREATE CACHE KEY\r\n    const cacheKey = CacheService.createKey('embedding', this.hashText(text));\r\n    \r\n    // ✅ CHECK CACHE FIRST\r\n    const cached = CacheService.get<number[]>(cacheKey);\r\n    if (cached) {\r\n      console.log('✅ Embedding cache HIT - saved $0.0001');\r\n      return cached;\r\n    }\r\n\r\n    // ✅ CACHE MISS - Generate new embedding\r\n    console.log('💰 Generating new embedding (costs $0.0001)');\r\n    const response = await openai.embeddings.create({\r\n      model: 'text-embedding-ada-002',\r\n      input: text,\r\n    });\r\n    \r\n    const embedding = response.data[0].embedding;\r\n    \r\n    // ✅ STORE IN CACHE (24 hours)\r\n    CacheService.set(cacheKey, embedding, 86400); // 24 hours\r\n    \r\n    return embedding;\r\n  }\r\n\r\n  /**\r\n   * Simple hash function for cache keys\r\n   */\r\n  private static hashText(text: string): string {\r\n    // Normalize text for caching\r\n    const normalized = text.toLowerCase().trim().replace(/\\s+/g, ' ');\r\n    \r\n    // Simple hash (good enough for caching similar queries)\r\n    let hash = 0;\r\n    for (let i = 0; i < normalized.length; i++) {\r\n      const char = normalized.charCodeAt(i);\r\n      hash = ((hash << 5) - hash) + char;\r\n      hash = hash & hash; // Convert to 32-bit integer\r\n    }\r\n    \r\n    return `${hash}_${normalized.substring(0, 50)}`;\r\n  }\r\n\r\n  /**\r\n   * Search for similar conversations using vector similarity (WITH CACHING)\r\n   */\r\n  static async searchSimilarConversations(\r\n    userMessage: string,\r\n    industry: string,\r\n    options: {\r\n      threshold?: number;\r\n      limit?: number;\r\n      includeExamples?: boolean;\r\n    } = {}\r\n  ): Promise<SemanticSearchResult> {\r\n    const {\r\n      threshold = 0.75,\r\n      limit = 5,\r\n      includeExamples = true,\r\n    } = options;\r\n\r\n    // ✅ CHECK RAG CACHE\r\n    const ragCacheKey = CacheService.createKey('rag', industry, this.hashText(userMessage));\r\n    const cachedResults = CacheService.get<SemanticSearchResult>(ragCacheKey);\r\n    \r\n    if (cachedResults) {\r\n      console.log('✅ RAG search cache HIT');\r\n      return cachedResults;\r\n    }\r\n\r\n    console.log('🔍 RAG search cache MISS - performing search');\r\n\r\n    // Generate embedding (this will use embedding cache)\r\n    const embedding = await this.generateEmbedding(userMessage);\r\n\r\n    // Search actual conversations\r\n    const { data: conversations, error: convError } = await supabase.rpc(\r\n      'match_conversations',\r\n      {\r\n        query_embedding: embedding,\r\n        match_industry: industry,\r\n        match_threshold: threshold,\r\n        match_count: limit,\r\n      }\r\n    );\r\n\r\n    if (convError) {\r\n      console.error('Error searching conversations:', convError);\r\n    }\r\n\r\n    // Search example conversations\r\n    let examples: any[] = [];\r\n    if (includeExamples) {\r\n      const { data: exampleData, error: exError } = await supabase.rpc(\r\n        'match_examples',\r\n        {\r\n          query_embedding: embedding,\r\n          match_industry: industry,\r\n          match_threshold: threshold,\r\n          match_count: limit,\r\n        }\r\n      );\r\n\r\n      if (exError) {\r\n        console.error('Error searching examples:', exError);\r\n      } else {\r\n        examples = exampleData || [];\r\n      }\r\n    }\r\n\r\n    // Combine and analyze results\r\n    const allResults = [\r\n      ...(conversations || []),\r\n      ...examples.map(e => ({\r\n        id: e.id,\r\n        userMessage: e.user_input,\r\n        assistantResponse: e.assistant_response,\r\n        problemDetected: e.problem_type,\r\n        solutionPresented: e.solution_type,\r\n        outcome: e.outcome,\r\n        conversionScore: e.conversion_score,\r\n        similarity: e.similarity,\r\n      })),\r\n    ];\r\n\r\n    // Extract detected problems\r\n    const problemCounts = new Map<string, number>();\r\n    allResults.forEach(r => {\r\n      if (r.problemDetected) {\r\n        problemCounts.set(\r\n          r.problemDetected,\r\n          (problemCounts.get(r.problemDetected) || 0) + 1\r\n        );\r\n      }\r\n    });\r\n\r\n    const detectedProblems = Array.from(problemCounts.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, 3)\r\n      .map(([problem]) => problem);\r\n\r\n    // Extract recommended solutions\r\n    const solutionCounts = new Map<string, number>();\r\n    allResults.forEach(r => {\r\n      if (r.solutionPresented) {\r\n        solutionCounts.set(\r\n          r.solutionPresented,\r\n          (solutionCounts.get(r.solutionPresented) || 0) + 1\r\n        );\r\n      }\r\n    });\r\n\r\n    const recommendedSolutions = Array.from(solutionCounts.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, 3)\r\n      .map(([solution]) => solution);\r\n\r\n    // Find best response pattern (highest conversion)\r\n    const bestPattern = allResults\r\n      .filter(r => r.conversionScore && r.conversionScore > 0.7)\r\n      .sort((a, b) => (b.conversionScore || 0) - (a.conversionScore || 0))[0];\r\n\r\n    // Calculate confidence scores\r\n    const avgSimilarity =\r\n      allResults.reduce((sum, r) => sum + r.similarity, 0) /\r\n      Math.max(allResults.length, 1);\r\n\r\n    const problemConfidence = Math.min(\r\n      problemCounts.size > 0 ? Math.max(...problemCounts.values()) / allResults.length : 0,\r\n      1\r\n    );\r\n\r\n    const solutionConfidence = Math.min(\r\n      solutionCounts.size > 0 ? Math.max(...solutionCounts.values()) / allResults.length : 0,\r\n      1\r\n    );\r\n\r\n    const results: SemanticSearchResult = {\r\n      similarConversations: allResults as SimilarConversation[],\r\n      detectedProblems,\r\n      recommendedSolutions,\r\n      bestPattern: bestPattern\r\n        ? {\r\n            approach: bestPattern.assistantResponse,\r\n            conversionScore: bestPattern.conversionScore || 0,\r\n            stage: 'solutioning',\r\n          }\r\n        : undefined,\r\n      confidence: {\r\n        problemDetection: problemConfidence,\r\n        solutionMatch: solutionConfidence,\r\n        overallConfidence: (avgSimilarity + problemConfidence + solutionConfidence) / 3,\r\n      },\r\n    };\r\n\r\n    // ✅ CACHE RAG RESULTS (1 hour)\r\n    CacheService.set(ragCacheKey, results, 3600);\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Build enhanced context for Sai\r\n   */\r\n  static async buildRAGContext(\r\n    userMessage: string,\r\n    industry: string,\r\n    conversationHistory: {\r\n      stage: string;\r\n      messageCount: number;\r\n      problemsDiscussed: string[];\r\n    }\r\n  ): Promise<RAGContext> {\r\n    const searchResults = await this.searchSimilarConversations(\r\n      userMessage,\r\n      industry\r\n    );\r\n\r\n    // Generate guidance based on search results\r\n    const guidance = this.generateGuidance(searchResults, conversationHistory);\r\n\r\n    return {\r\n      userMessage,\r\n      searchResults,\r\n      conversationHistory,\r\n      guidance,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate guidance for Sai based on RAG results\r\n   */\r\n  private static generateGuidance(\r\n    searchResults: SemanticSearchResult,\r\n    conversationHistory: any\r\n  ): RAGContext['guidance'] {\r\n    const { confidence, detectedProblems, bestPattern } = searchResults;\r\n\r\n    const keyPoints: string[] = [];\r\n    const avoidTopics: string[] = [];\r\n    let urgencyLevel: 'low' | 'medium' | 'high' = 'low';\r\n\r\n    // High confidence - use proven approach\r\n    if (confidence.overallConfidence > 0.8 && bestPattern) {\r\n      keyPoints.push(\r\n        `Similar conversations with ${Math.round(bestPattern.conversionScore * 100)}% conversion rate used this approach`\r\n      );\r\n      keyPoints.push('Focus on problem quantification and impact');\r\n    }\r\n\r\n    // Medium confidence - suggest exploration\r\n    if (confidence.overallConfidence > 0.5 && confidence.overallConfidence <= 0.8) {\r\n      keyPoints.push('Ask 2-3 discovery questions to clarify the problem');\r\n      keyPoints.push('Avoid premature solution presentation');\r\n    }\r\n\r\n    // Low confidence - stay in discovery\r\n    if (confidence.overallConfidence <= 0.5) {\r\n      keyPoints.push('Stay in discovery mode - ask open-ended questions');\r\n      avoidTopics.push('Specific solution recommendations');\r\n    }\r\n\r\n    // Detect urgency based on problem patterns\r\n    if (detectedProblems.some(p => p.includes('churn') || p.includes('fraud'))) {\r\n      urgencyLevel = 'high';\r\n      keyPoints.push('Emphasize cost of inaction and urgency');\r\n    }\r\n\r\n    const suggestedApproach =\r\n      confidence.overallConfidence > 0.8\r\n        ? 'Present solution with proven talking points'\r\n        : confidence.overallConfidence > 0.5\r\n        ? 'Ask qualifying questions to confirm problem'\r\n        : 'Continue discovery to understand pain points';\r\n\r\n    return {\r\n      suggestedApproach,\r\n      keyPoints,\r\n      avoidTopics,\r\n      urgencyLevel,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Store conversation with embedding for future learning\r\n   */\r\n  static async storeConversation(data: {\r\n    industry: string;\r\n    sessionId: string;\r\n    userMessage: string;\r\n    assistantResponse: string;\r\n    conversationStage: string;\r\n    outcome?: string;\r\n    problemDetected?: string;\r\n    solutionPresented?: string;\r\n    organizationId?: string;\r\n    conversionScore?: number;\r\n    bookingCompleted?: boolean;\r\n    responseTimeMs?: number;\r\n    userSatisfaction?: number;\r\n  }): Promise<void> {\r\n    try {\r\n      // Generate embedding for user message (will use cache if available)\r\n      const embedding = await this.generateEmbedding(data.userMessage);\r\n\r\n      // Use default org ID if not provided (public chatbot)\r\n      const orgId = data.organizationId || 'public-chatbot-org';\r\n\r\n      const { error } = await supabase.from('conversations').insert({\r\n        organization_id: orgId,\r\n        industry: data.industry,\r\n        session_id: data.sessionId,\r\n        user_message: data.userMessage,\r\n        assistant_response: data.assistantResponse,\r\n        embedding: embedding,\r\n        conversation_stage: data.conversationStage,\r\n        outcome: data.outcome,\r\n        problem_detected: data.problemDetected,\r\n        solution_presented: data.solutionPresented,\r\n        conversion_score: data.conversionScore,\r\n        booking_completed: data.bookingCompleted,\r\n        response_time_ms: data.responseTimeMs,\r\n        user_satisfaction: data.userSatisfaction,\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Failed to store conversation:', error);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to store conversation:', error);\r\n      // Don't throw - logging failure shouldn't break chat\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mark conversation as successful (booking completed)\r\n   */\r\n  static async markConversationSuccess(\r\n    sessionId: string,\r\n    conversionScore: number = 1.0\r\n  ): Promise<void> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('conversations')\r\n        .update({\r\n          outcome: 'booking_completed',\r\n          booking_completed: true,\r\n          conversion_score: conversionScore,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('session_id', sessionId);\r\n\r\n      if (error) {\r\n        console.error('Error marking conversation success:', error);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error marking conversation success:', error);\r\n    }\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1866, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/shared/lib/services/cache-service.ts"],"sourcesContent":["// shared/lib/services/cache-service.ts\r\n// Shared in-memory caching service with TTL support\r\n\r\ninterface CacheEntry<T> {\r\n  data: T;\r\n  expires: number;\r\n}\r\n\r\nexport class CacheService {\r\n  private static cache = new Map<string, CacheEntry<any>>();\r\n  private static readonly DEFAULT_TTL = 3600; // 1 hour in seconds\r\n  private static cleanupInterval: NodeJS.Timeout | null = null;\r\n\r\n  /**\r\n   * Set a value in cache with TTL\r\n   */\r\n  static set<T>(key: string, value: T, ttl: number = this.DEFAULT_TTL): void {\r\n    this.cache.set(key, {\r\n      data: value,\r\n      expires: Date.now() + ttl * 1000,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get a value from cache (returns null if expired or not found)\r\n   */\r\n  static get<T>(key: string): T | null {\r\n    const entry = this.cache.get(key);\r\n\r\n    if (!entry) {\r\n      return null;\r\n    }\r\n\r\n    // Check if expired\r\n    if (entry.expires < Date.now()) {\r\n      this.cache.delete(key);\r\n      return null;\r\n    }\r\n\r\n    return entry.data as T;\r\n  }\r\n\r\n  /**\r\n   * Delete a specific key\r\n   */\r\n  static delete(key: string): void {\r\n    this.cache.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Clear all cache\r\n   */\r\n  static clear(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics\r\n   */\r\n  static getStats(): {\r\n    size: number;\r\n    entries: string[];\r\n  } {\r\n    return {\r\n      size: this.cache.size,\r\n      entries: Array.from(this.cache.keys()),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if a key exists and is not expired\r\n   */\r\n  static has(key: string): boolean {\r\n    const entry = this.cache.get(key);\r\n    if (!entry) return false;\r\n\r\n    if (entry.expires < Date.now()) {\r\n      this.cache.delete(key);\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Cleanup expired entries periodically\r\n   */\r\n  static startCleanup(intervalMs: number = 60000): void {\r\n    if (this.cleanupInterval) {\r\n      return; // Already running\r\n    }\r\n\r\n    this.cleanupInterval = setInterval(() => {\r\n      const now = Date.now();\r\n      let cleaned = 0;\r\n\r\n      for (const [key, entry] of this.cache.entries()) {\r\n        if (entry.expires < now) {\r\n          this.cache.delete(key);\r\n          cleaned++;\r\n        }\r\n      }\r\n\r\n      if (cleaned > 0) {\r\n        console.log(`🧹 Cache cleanup: Removed ${cleaned} expired entries`);\r\n      }\r\n    }, intervalMs);\r\n  }\r\n\r\n  /**\r\n   * Stop cleanup interval\r\n   */\r\n  static stopCleanup(): void {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n      this.cleanupInterval = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Simple hash function for creating cache keys\r\n   */\r\n  static createKey(...parts: (string | number)[]): string {\r\n    return parts.join(':');\r\n  }\r\n}\r\n\r\n// Initialize cleanup on server start (only in Node.js environment)\r\nif (typeof window === 'undefined') {\r\n  CacheService.startCleanup();\r\n}\r\n"],"names":[],"mappings":"AAAA,uCAAuC;AACvC,oDAAoD;;;;;AAO7C,MAAM;IACX,OAAe,QAAQ,IAAI,MAA+B;IAC1D,OAAwB,cAAc,KAAK;IAC3C,OAAe,kBAAyC,KAAK;IAE7D;;GAEC,GACD,OAAO,IAAO,GAAW,EAAE,KAAQ,EAAE,MAAc,IAAI,CAAC,WAAW,EAAQ;QACzE,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK;YAClB,MAAM;YACN,SAAS,KAAK,GAAG,KAAK,MAAM;QAC9B;IACF;IAEA;;GAEC,GACD,OAAO,IAAO,GAAW,EAAY;QACnC,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE7B,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,mBAAmB;QACnB,IAAI,MAAM,OAAO,GAAG,KAAK,GAAG,IAAI;YAC9B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YAClB,OAAO;QACT;QAEA,OAAO,MAAM,IAAI;IACnB;IAEA;;GAEC,GACD,OAAO,OAAO,GAAW,EAAQ;QAC/B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;IACpB;IAEA;;GAEC,GACD,OAAO,QAAc;QACnB,IAAI,CAAC,KAAK,CAAC,KAAK;IAClB;IAEA;;GAEC,GACD,OAAO,WAGL;QACA,OAAO;YACL,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI;YACrB,SAAS,MAAM,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI;QACrC;IACF;IAEA;;GAEC,GACD,OAAO,IAAI,GAAW,EAAW;QAC/B,MAAM,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAC7B,IAAI,CAAC,OAAO,OAAO;QAEnB,IAAI,MAAM,OAAO,GAAG,KAAK,GAAG,IAAI;YAC9B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YAClB,OAAO;QACT;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,OAAO,aAAa,aAAqB,KAAK,EAAQ;QACpD,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,kBAAkB;QAC5B;QAEA,IAAI,CAAC,eAAe,GAAG,YAAY;YACjC,MAAM,MAAM,KAAK,GAAG;YACpB,IAAI,UAAU;YAEd,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,GAAI;gBAC/C,IAAI,MAAM,OAAO,GAAG,KAAK;oBACvB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;oBAClB;gBACF;YACF;YAEA,IAAI,UAAU,GAAG;gBACf,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,QAAQ,gBAAgB,CAAC;YACpE;QACF,GAAG;IACL;IAEA;;GAEC,GACD,OAAO,cAAoB;QACzB,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,cAAc,IAAI,CAAC,eAAe;YAClC,IAAI,CAAC,eAAe,GAAG;QACzB;IACF;IAEA;;GAEC,GACD,OAAO,UAAU,GAAG,KAA0B,EAAU;QACtD,OAAO,MAAM,IAAI,CAAC;IACpB;AACF;AAEA,mEAAmE;AACnE,wCAAmC;IACjC,aAAa,YAAY;AAC3B","debugId":null}},
    {"offset": {"line": 1969, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/services/rentcast-service.ts"],"sourcesContent":["// app/lib/modules/real-estate/services/rentcast-service.ts\r\nimport 'server-only';\r\n\r\nimport { CacheService } from '@strive/shared/services/cache-service';\r\n\r\n// Environment variable for RentCast API key\r\nconst RENTCAST_API_KEY = process.env.RENTCAST_API_KEY;\r\nconst RENTCAST_BASE_URL = 'https://api.rentcast.io/v1';\r\n\r\nexport interface PropertySearchParams {\r\n  location: string; // \"Nashville, TN\" or \"37209\"\r\n  maxPrice: number;\r\n  minBedrooms: number;\r\n  minBathrooms?: number;\r\n  mustHaveFeatures: string[];\r\n  niceToHaveFeatures?: string[];\r\n  propertyType?: 'single-family' | 'condo' | 'townhouse' | 'multi-family';\r\n  radius?: number; // miles from location\r\n}\r\n\r\nexport interface Property {\r\n  id: string;\r\n  address: string;\r\n  city: string;\r\n  state: string;\r\n  zipCode: string;\r\n  price: number;\r\n  bedrooms: number;\r\n  bathrooms: number;\r\n  sqft: number;\r\n  lotSize?: number;\r\n  propertyType: string;\r\n  yearBuilt?: number;\r\n  features: string[];\r\n  images: string[];\r\n  daysOnMarket: number;\r\n  listingDate: string;\r\n  description?: string;\r\n  schoolRatings?: {\r\n    elementary?: number;\r\n    middle?: number;\r\n    high?: number;\r\n  };\r\n  mlsId?: string;\r\n  agentInfo?: {\r\n    name: string;\r\n    phone: string;\r\n    email: string;\r\n  };\r\n}\r\n\r\nexport interface PropertyMatch {\r\n  property: Property;\r\n  matchScore: number;\r\n  matchReasons: string[];\r\n  missingFeatures: string[];\r\n}\r\n\r\nexport class RentCastService {\r\n  /**\r\n   * Search properties using RentCast API\r\n   */\r\n  static async searchProperties(params: PropertySearchParams): Promise<Property[]> {\r\n    // Create cache key based on search params\r\n    const cacheKey = CacheService.createKey(\r\n      'rentcast',\r\n      params.location,\r\n      params.maxPrice.toString(),\r\n      params.minBedrooms.toString(),\r\n      params.propertyType || 'any'\r\n    );\r\n\r\n    // Check cache first (15 minute TTL for property searches)\r\n    const cached = CacheService.get<Property[]>(cacheKey);\r\n    if (cached) {\r\n      console.log('✅ RentCast cache HIT');\r\n      return cached;\r\n    }\r\n\r\n    console.log('🔍 RentCast cache MISS - fetching from API');\r\n\r\n    try {\r\n      // Parse location to get city and state\r\n      const { city, state, zipCode } = this.parseLocation(params.location);\r\n\r\n      // Build RentCast API request\r\n      const url = new URL(`${RENTCAST_BASE_URL}/listings/sale`);\r\n      url.searchParams.append('city', city);\r\n      url.searchParams.append('state', state);\r\n      if (zipCode) url.searchParams.append('zipCode', zipCode);\r\n      url.searchParams.append('maxPrice', params.maxPrice.toString());\r\n      url.searchParams.append('bedrooms', params.minBedrooms.toString());\r\n      if (params.minBathrooms) {\r\n        url.searchParams.append('bathrooms', params.minBathrooms.toString());\r\n      }\r\n      if (params.propertyType) {\r\n        url.searchParams.append('propertyType', params.propertyType);\r\n      }\r\n      url.searchParams.append('status', 'Active');\r\n      url.searchParams.append('limit', '50'); // Get more than 5 for better matching\r\n\r\n      const response = await fetch(url.toString(), {\r\n        headers: {\r\n          'X-Api-Key': RENTCAST_API_KEY!,\r\n          'Accept': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`RentCast API error: ${response.status} ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      // Transform RentCast response to our Property format\r\n      const properties: Property[] = data.map((listing: any) => this.transformListing(listing));\r\n\r\n      // Cache results for 15 minutes\r\n      CacheService.set(cacheKey, properties, 900);\r\n\r\n      return properties;\r\n    } catch (error) {\r\n      console.error('RentCast API error:', error);\r\n      throw new Error('Failed to fetch property listings. Please try again.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enhanced property matching algorithm with intelligent scoring\r\n   */\r\n  static matchProperties(\r\n    properties: Property[],\r\n    params: PropertySearchParams\r\n  ): PropertyMatch[] {\r\n    const matches: PropertyMatch[] = [];\r\n\r\n    for (const property of properties) {\r\n      let score = 0;\r\n      const matchReasons: string[] = [];\r\n      const missingFeatures: string[] = [];\r\n\r\n      // ========================================\r\n      // 1. PRICE MATCHING (Max 35 points)\r\n      // ========================================\r\n      if (property.price > params.maxPrice) continue; // Hard filter - over budget\r\n\r\n      const priceDiff = params.maxPrice - property.price;\r\n      const pricePercentUnderBudget = (priceDiff / params.maxPrice) * 100;\r\n\r\n      // Sweet spot: 5-15% under budget gets maximum points\r\n      if (pricePercentUnderBudget >= 5 && pricePercentUnderBudget <= 15) {\r\n        score += 35; // Perfect price range\r\n        matchReasons.push(`Perfect price - $${priceDiff.toLocaleString()} under budget`);\r\n      } else if (pricePercentUnderBudget > 15) {\r\n        score += 25; // Way under budget (might be missing features)\r\n        matchReasons.push(`Great value - well under budget`);\r\n      } else if (pricePercentUnderBudget >= 0) {\r\n        score += 20; // At or slightly under budget\r\n      }\r\n\r\n      // ========================================\r\n      // 2. BEDROOM MATCHING (Max 25 points)\r\n      // ========================================\r\n      if (property.bedrooms < params.minBedrooms) continue; // Hard filter\r\n\r\n      if (property.bedrooms === params.minBedrooms) {\r\n        score += 25; // Exact match\r\n      } else if (property.bedrooms === params.minBedrooms + 1) {\r\n        score += 30; // One extra bedroom (bonus!)\r\n        matchReasons.push(`${property.bedrooms} bedrooms (bonus room)`);\r\n      } else if (property.bedrooms > params.minBedrooms + 1) {\r\n        score += 20; // Too many bedrooms might mean higher maintenance\r\n        matchReasons.push(`${property.bedrooms} bedrooms (spacious)`);\r\n      }\r\n\r\n      // ========================================\r\n      // 3. BATHROOM MATCHING (Max 20 points)\r\n      // ========================================\r\n      if (params.minBathrooms) {\r\n        if (property.bathrooms >= params.minBathrooms) {\r\n          score += 15;\r\n          if (property.bathrooms > params.minBathrooms) {\r\n            score += 5;\r\n            matchReasons.push(`${property.bathrooms} bathrooms`);\r\n          }\r\n        }\r\n      } else {\r\n        // No bathroom preference - still reward more bathrooms\r\n        if (property.bathrooms >= 2) {\r\n          score += 10;\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 4. MUST-HAVE FEATURES (Max 40 points)\r\n      // ========================================\r\n      const mustHaveFeatures = params.mustHaveFeatures || [];\r\n      let mustHaveMatches = 0;\r\n      let mustHaveMisses = 0;\r\n\r\n      for (const feature of mustHaveFeatures) {\r\n        const hasFeature = this.propertyHasFeature(property, feature);\r\n        if (hasFeature) {\r\n          mustHaveMatches++;\r\n          score += 15; // High value for must-haves\r\n          matchReasons.push(`✓ ${this.formatFeature(feature)}`);\r\n        } else {\r\n          mustHaveMisses++;\r\n          missingFeatures.push(this.formatFeature(feature));\r\n          score -= 10; // Heavy penalty for missing must-haves\r\n        }\r\n      }\r\n\r\n      // Bonus for having ALL must-haves\r\n      if (mustHaveFeatures.length > 0 && mustHaveMisses === 0) {\r\n        score += 10;\r\n        matchReasons.push('Has all must-have features!');\r\n      }\r\n\r\n      // ========================================\r\n      // 5. NICE-TO-HAVE FEATURES (Max 15 points)\r\n      // ========================================\r\n      const niceToHaves = params.niceToHaveFeatures || [];\r\n      let niceToHaveCount = 0;\r\n\r\n      for (const feature of niceToHaves) {\r\n        if (this.propertyHasFeature(property, feature)) {\r\n          niceToHaveCount++;\r\n          score += 5; // Smaller bonus for nice-to-haves\r\n          matchReasons.push(`+ ${this.formatFeature(feature)}`);\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 6. PROPERTY TYPE MATCHING (Max 15 points)\r\n      // ========================================\r\n      if (params.propertyType && params.propertyType !== 'any') {\r\n        const propertyTypeNormalized = property.propertyType?.toLowerCase().replace(/[-\\s]/g, '');\r\n        const targetTypeNormalized = params.propertyType.toLowerCase().replace(/[-\\s]/g, '');\r\n\r\n        if (propertyTypeNormalized?.includes(targetTypeNormalized) ||\r\n            targetTypeNormalized?.includes(propertyTypeNormalized || '')) {\r\n          score += 15;\r\n        } else {\r\n          score -= 5; // Small penalty for wrong type\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 7. DAYS ON MARKET (Max 15 points)\r\n      // ========================================\r\n      if (property.daysOnMarket <= 3) {\r\n        score += 15;\r\n        matchReasons.push('🔥 Just listed!');\r\n      } else if (property.daysOnMarket <= 7) {\r\n        score += 10;\r\n        matchReasons.push('Recently listed');\r\n      } else if (property.daysOnMarket <= 30) {\r\n        score += 5;\r\n      } else if (property.daysOnMarket > 90) {\r\n        score -= 5; // Been on market a while - might be overpriced\r\n      }\r\n\r\n      // ========================================\r\n      // 8. PROPERTY CONDITION (Max 10 points)\r\n      // ========================================\r\n      if (property.yearBuilt) {\r\n        const age = new Date().getFullYear() - property.yearBuilt;\r\n\r\n        if (age <= 5) {\r\n          score += 10;\r\n          matchReasons.push('Brand new construction');\r\n        } else if (age <= 15) {\r\n          score += 7;\r\n          matchReasons.push('Modern build');\r\n        } else if (age <= 30) {\r\n          score += 3;\r\n        } else if (age > 50) {\r\n          score -= 3; // Older homes might need work\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 9. SCHOOL RATINGS (Max 15 points)\r\n      // ========================================\r\n      if (property.schoolRatings) {\r\n        const avgRating = (\r\n          (property.schoolRatings.elementary || 0) +\r\n          (property.schoolRatings.middle || 0) +\r\n          (property.schoolRatings.high || 0)\r\n        ) / 3;\r\n\r\n        if (avgRating >= 9) {\r\n          score += 15;\r\n          matchReasons.push('⭐ Exceptional schools nearby');\r\n        } else if (avgRating >= 8) {\r\n          score += 12;\r\n          matchReasons.push('Top-rated schools');\r\n        } else if (avgRating >= 7) {\r\n          score += 8;\r\n          matchReasons.push('Great schools');\r\n        } else if (avgRating >= 6) {\r\n          score += 4;\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 10. PRICE PER SQFT EFFICIENCY (Max 10 points)\r\n      // ========================================\r\n      if (property.sqft > 0) {\r\n        const pricePerSqft = property.price / property.sqft;\r\n\r\n        // Market average varies by location - using $200 as baseline\r\n        const marketAvg = 200;\r\n\r\n        if (pricePerSqft < marketAvg * 0.75) {\r\n          score += 10;\r\n          matchReasons.push('Excellent value per sqft');\r\n        } else if (pricePerSqft < marketAvg * 0.9) {\r\n          score += 7;\r\n          matchReasons.push('Good value');\r\n        } else if (pricePerSqft > marketAvg * 1.2) {\r\n          score -= 5; // Overpriced per sqft\r\n        }\r\n      }\r\n\r\n      // ========================================\r\n      // 11. LOT SIZE (Max 5 points)\r\n      // ========================================\r\n      if (property.lotSize && property.lotSize > 10000) {\r\n        score += 5;\r\n        matchReasons.push('Large lot');\r\n      }\r\n\r\n      // Calculate match percentage (0-100%)\r\n      const maxPossibleScore = 200; // Approximate max from all categories\r\n      const matchPercentage = Math.min(Math.round((score / maxPossibleScore) * 100), 100);\r\n\r\n      matches.push({\r\n        property,\r\n        matchScore: score,\r\n        matchReasons: matchReasons.slice(0, 5), // Limit to top 5 reasons\r\n        missingFeatures,\r\n      });\r\n    }\r\n\r\n    // Sort by match score (highest first) and return top 5\r\n    return matches\r\n      .sort((a, b) => b.matchScore - a.matchScore)\r\n      .slice(0, 5)\r\n      .map(match => ({\r\n        ...match,\r\n        // Add match percentage for display\r\n        matchScore: Math.max(match.matchScore, 0), // Ensure non-negative\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * Check if property has a specific feature\r\n   */\r\n  private static propertyHasFeature(property: Property, feature: string): boolean {\r\n    const normalizedFeature = feature.toLowerCase().trim();\r\n    const searchTerms = property.features.concat(property.description || '').join(' ').toLowerCase();\r\n\r\n    // Map common feature requests to property attributes\r\n    const featureMap: Record<string, string[]> = {\r\n      'backyard': ['backyard', 'yard', 'outdoor space', 'patio'],\r\n      'pool': ['pool', 'swimming pool', 'swim'],\r\n      'garage': ['garage', 'parking', 'carport'],\r\n      'updated kitchen': ['updated kitchen', 'renovated kitchen', 'modern kitchen', 'new kitchen'],\r\n      'fireplace': ['fireplace', 'wood burning'],\r\n      'hardwood floors': ['hardwood', 'wood floor'],\r\n      'stainless appliances': ['stainless', 'stainless steel appliances'],\r\n      'master suite': ['master suite', 'primary suite'],\r\n      'walk-in closet': ['walk-in closet', 'walkin closet'],\r\n      'fenced yard': ['fenced', 'fence'],\r\n    };\r\n\r\n    const searchKeys = featureMap[normalizedFeature] || [normalizedFeature];\r\n    return searchKeys.some(key => searchTerms.includes(key));\r\n  }\r\n\r\n  /**\r\n   * Format feature name for display\r\n   */\r\n  private static formatFeature(feature: string): string {\r\n    return feature.charAt(0).toUpperCase() + feature.slice(1);\r\n  }\r\n\r\n  /**\r\n   * Parse location string into components\r\n   */\r\n  private static parseLocation(location: string): {\r\n    city: string;\r\n    state: string;\r\n    zipCode?: string;\r\n  } {\r\n    // Handle formats: \"Nashville, TN\", \"37209\", \"Nashville TN 37209\"\r\n    const parts = location.split(/[,\\s]+/).filter(Boolean);\r\n\r\n    if (parts.length === 1) {\r\n      // Could be just a zip code\r\n      if (/^\\d{5}$/.test(parts[0])) {\r\n        return { city: '', state: '', zipCode: parts[0] };\r\n      }\r\n      // Or just a city name\r\n      return { city: parts[0], state: '' };\r\n    }\r\n\r\n    if (parts.length === 2) {\r\n      return { city: parts[0], state: parts[1] };\r\n    }\r\n\r\n    // \"Nashville TN 37209\"\r\n    return {\r\n      city: parts[0],\r\n      state: parts[1],\r\n      zipCode: parts[2],\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Transform RentCast listing to our Property format\r\n   */\r\n  private static transformListing(listing: any): Property {\r\n    return {\r\n      id: listing.id || listing.listingId,\r\n      address: listing.addressLine1 || listing.address,\r\n      city: listing.city,\r\n      state: listing.state,\r\n      zipCode: listing.zipCode,\r\n      price: listing.price,\r\n      bedrooms: listing.bedrooms,\r\n      bathrooms: listing.bathrooms,\r\n      sqft: listing.squareFootage || listing.livingArea,\r\n      lotSize: listing.lotSize,\r\n      propertyType: listing.propertyType,\r\n      yearBuilt: listing.yearBuilt,\r\n      features: listing.features || this.extractFeatures(listing.description),\r\n      images: listing.photos?.map((p: any) => p.href || p.url) || [],\r\n      daysOnMarket: this.calculateDaysOnMarket(listing.listDate),\r\n      listingDate: listing.listDate,\r\n      description: listing.description,\r\n      schoolRatings: listing.schools ? {\r\n        elementary: listing.schools.elementary?.rating,\r\n        middle: listing.schools.middle?.rating,\r\n        high: listing.schools.high?.rating,\r\n      } : undefined,\r\n      mlsId: listing.mlsId,\r\n      agentInfo: listing.listingAgent ? {\r\n        name: listing.listingAgent.name,\r\n        phone: listing.listingAgent.phone,\r\n        email: listing.listingAgent.email,\r\n      } : undefined,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Extract features from description text\r\n   */\r\n  private static extractFeatures(description?: string): string[] {\r\n    if (!description) return [];\r\n    \r\n    const features: string[] = [];\r\n    const lowerDesc = description.toLowerCase();\r\n\r\n    const featurePatterns = [\r\n      'pool', 'backyard', 'garage', 'fireplace', 'hardwood',\r\n      'granite', 'stainless', 'updated', 'renovated', 'new',\r\n    ];\r\n\r\n    for (const pattern of featurePatterns) {\r\n      if (lowerDesc.includes(pattern)) {\r\n        features.push(pattern);\r\n      }\r\n    }\r\n\r\n    return features;\r\n  }\r\n\r\n  /**\r\n   * Calculate days on market\r\n   */\r\n  private static calculateDaysOnMarket(listDate: string): number {\r\n    const listed = new Date(listDate);\r\n    const now = new Date();\r\n    const diffTime = Math.abs(now.getTime() - listed.getTime());\r\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n    return diffDays;\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2393, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/schemas/chat-request.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\nexport const MessageSchema = z.object({\r\n  role: z.enum(['user', 'assistant', 'system']),\r\n  content: z.string().min(1).max(10000),\r\n  timestamp: z.string().optional(),\r\n  id: z.string().optional()\r\n});\r\n\r\nexport const ChatRequestSchema = z.object({\r\n  messages: z.array(MessageSchema).min(1).max(50),\r\n  industry: z.string().default('strive'),\r\n  sessionId: z.string().min(1),\r\n  organizationId: z.string().optional(), // For CRM integration\r\n  conversationStage: z.string().optional(),\r\n  detectedProblems: z.array(z.string()).optional(),\r\n  clientId: z.string().optional()\r\n});\r\n\r\nexport type ChatRequest = z.infer<typeof ChatRequestSchema>;\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,gBAAgB,yKAAC,CAAC,MAAM,CAAC;IACpC,MAAM,yKAAC,CAAC,IAAI,CAAC;QAAC;QAAQ;QAAa;KAAS;IAC5C,SAAS,yKAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;IAC/B,WAAW,yKAAC,CAAC,MAAM,GAAG,QAAQ;IAC9B,IAAI,yKAAC,CAAC,MAAM,GAAG,QAAQ;AACzB;AAEO,MAAM,oBAAoB,yKAAC,CAAC,MAAM,CAAC;IACxC,UAAU,yKAAC,CAAC,KAAK,CAAC,eAAe,GAAG,CAAC,GAAG,GAAG,CAAC;IAC5C,UAAU,yKAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC7B,WAAW,yKAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC1B,gBAAgB,yKAAC,CAAC,MAAM,GAAG,QAAQ;IACnC,mBAAmB,yKAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,kBAAkB,yKAAC,CAAC,KAAK,CAAC,yKAAC,CAAC,MAAM,IAAI,QAAQ;IAC9C,UAAU,yKAAC,CAAC,MAAM,GAAG,QAAQ;AAC/B","debugId":null}},
    {"offset": {"line": 2424, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/lib/ai/data-extraction.ts"],"sourcesContent":["// lib/ai/data-extraction.ts\r\nimport 'server-only';\r\n\r\nimport Groq from 'groq-sdk';\r\nimport { z } from 'zod';\r\n\r\nconst groq = new Groq({\r\n  apiKey: process.env.GROQ_API_KEY,\r\n});\r\n\r\n/**\r\n * Property search parameters that can be extracted from user messages\r\n */\r\nexport const PropertyPreferencesSchema = z.object({\r\n  location: z.string().optional().describe('City, state, zip code, or neighborhood'),\r\n  maxPrice: z.number().positive().optional().describe('Maximum budget in dollars'),\r\n  minBedrooms: z.number().int().positive().optional().describe('Minimum number of bedrooms'),\r\n  minBathrooms: z.number().positive().optional().describe('Minimum number of bathrooms'),\r\n  mustHaveFeatures: z.array(z.string()).optional().describe('Must-have features like pool, backyard, garage'),\r\n  niceToHaveFeatures: z.array(z.string()).optional().describe('Nice-to-have features'),\r\n  propertyType: z.enum(['single-family', 'condo', 'townhouse', 'multi-family', 'any']).optional().describe('Type of property'),\r\n  timeline: z.enum(['ASAP', 'WITHIN_1_MONTH', 'WITHIN_3_MONTHS', 'WITHIN_6_MONTHS', 'FLEXIBLE']).optional().describe('How soon they want to move'),\r\n  isFirstTimeBuyer: z.boolean().optional().describe('Is this their first home purchase'),\r\n  currentSituation: z.enum(['renting', 'selling', 'first-time', 'relocating', 'unknown']).optional().describe('Current living situation'),\r\n});\r\n\r\nexport type PropertyPreferences = z.infer<typeof PropertyPreferencesSchema>;\r\n\r\n/**\r\n * Contact information that can be extracted\r\n */\r\nexport const ContactInfoSchema = z.object({\r\n  name: z.string().optional().describe('Full name'),\r\n  email: z.string().email().optional().describe('Email address'),\r\n  phone: z.string().optional().describe('Phone number'),\r\n});\r\n\r\nexport type ContactInfo = z.infer<typeof ContactInfoSchema>;\r\n\r\n/**\r\n * Combined extraction result\r\n */\r\nexport interface ExtractionResult {\r\n  propertyPreferences: PropertyPreferences;\r\n  contactInfo: ContactInfo;\r\n  extractedFields: string[]; // List of fields that were successfully extracted\r\n  confidence: number; // 0-1 confidence score\r\n}\r\n\r\n/**\r\n * Extract property preferences and contact info from user message using AI function calling\r\n * This allows natural extraction like:\r\n *   \"Nashville, $700k\" → { location: \"Nashville\", maxPrice: 700000 }\r\n *   \"3 bed 2 bath house with pool\" → { minBedrooms: 3, minBathrooms: 2, mustHaveFeatures: [\"pool\"] }\r\n */\r\nexport async function extractDataFromMessage(\r\n  userMessage: string,\r\n  conversationHistory: Array<{ role: 'user' | 'assistant'; content: string }> = []\r\n): Promise<ExtractionResult> {\r\n  try {\r\n    // Use Groq with function calling for fast, structured extraction\r\n    const completion = await groq.chat.completions.create({\r\n      model: 'llama-3.3-70b-versatile', // Fast and free\r\n      temperature: 0.1, // Low temperature for consistent extraction\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: `You are a data extraction assistant for a real estate chatbot.\r\nExtract property search preferences and contact information from user messages.\r\n\r\nIMPORTANT EXTRACTION RULES:\r\n\r\n1. LOCATION:\r\n   - Extract city, state, zip codes\r\n   - Examples: \"Nashville, TN\", \"Austin\", \"37209\", \"Denver, Colorado\"\r\n\r\n2. PRICE/BUDGET:\r\n   - Convert shorthand to full numbers: \"$500k\" → 500000, \"$1.2M\" → 1200000\r\n   - Examples: \"$700k\", \"$850,000\", \"under $1 million\"\r\n\r\n3. BEDROOMS/BATHROOMS:\r\n   - Extract from phrases like: \"3 bed\", \"4 bedroom\", \"3BR\", \"2.5 bath\"\r\n   - Examples: \"3 bed 2 bath\", \"4BR/3BA\"\r\n\r\n4. FEATURES:\r\n   - Extract mentioned amenities: pool, backyard, garage, fireplace, etc.\r\n   - Map variations: \"yard\" → \"backyard\", \"2 car garage\" → \"garage\"\r\n\r\n5. PROPERTY TYPE:\r\n   - Detect: single-family, condo, townhouse, multi-family\r\n   - \"house\" → single-family, \"apartment\" → condo\r\n\r\n6. TIMELINE:\r\n   - \"ASAP\" → immediate need\r\n   - \"next month\" → WITHIN_1_MONTH\r\n   - \"6 months\" → WITHIN_6_MONTHS\r\n   - \"flexible\" → FLEXIBLE\r\n\r\n7. CONTACT INFO:\r\n   - Extract names, emails, phone numbers when provided\r\n   - Be liberal in extraction but validate formats\r\n\r\nOnly extract information explicitly mentioned or strongly implied in the current message.\r\nDo NOT make assumptions beyond what's stated.`,\r\n        },\r\n        ...conversationHistory.map(msg => ({\r\n          role: msg.role,\r\n          content: msg.content,\r\n        })),\r\n        {\r\n          role: 'user',\r\n          content: userMessage,\r\n        },\r\n      ],\r\n      tools: [\r\n        {\r\n          type: 'function' as const,\r\n          function: {\r\n            name: 'extract_property_preferences',\r\n            description: 'Extract property search preferences from user message',\r\n            parameters: {\r\n              type: 'object',\r\n              properties: {\r\n                location: {\r\n                  type: 'string',\r\n                  description: 'City, state, zip code, or neighborhood (e.g., \"Nashville, TN\", \"37209\")',\r\n                },\r\n                maxPrice: {\r\n                  type: 'number',\r\n                  description: 'Maximum budget in dollars (convert \"500k\" to 500000)',\r\n                },\r\n                minBedrooms: {\r\n                  type: 'integer',\r\n                  description: 'Minimum number of bedrooms',\r\n                },\r\n                minBathrooms: {\r\n                  type: 'number',\r\n                  description: 'Minimum number of bathrooms (can be decimal like 2.5)',\r\n                },\r\n                mustHaveFeatures: {\r\n                  type: 'array',\r\n                  items: { type: 'string' },\r\n                  description: 'Must-have features (pool, backyard, garage, etc.)',\r\n                },\r\n                niceToHaveFeatures: {\r\n                  type: 'array',\r\n                  items: { type: 'string' },\r\n                  description: 'Nice-to-have features',\r\n                },\r\n                propertyType: {\r\n                  type: 'string',\r\n                  enum: ['single-family', 'condo', 'townhouse', 'multi-family', 'any'],\r\n                  description: 'Type of property desired',\r\n                },\r\n                timeline: {\r\n                  type: 'string',\r\n                  enum: ['ASAP', 'WITHIN_1_MONTH', 'WITHIN_3_MONTHS', 'WITHIN_6_MONTHS', 'FLEXIBLE'],\r\n                  description: 'Timeline for moving/purchasing',\r\n                },\r\n                isFirstTimeBuyer: {\r\n                  type: 'boolean',\r\n                  description: 'Is this a first-time home buyer?',\r\n                },\r\n                currentSituation: {\r\n                  type: 'string',\r\n                  enum: ['renting', 'selling', 'first-time', 'relocating', 'unknown'],\r\n                  description: 'Current living situation',\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        {\r\n          type: 'function' as const,\r\n          function: {\r\n            name: 'extract_contact_info',\r\n            description: 'Extract contact information from user message',\r\n            parameters: {\r\n              type: 'object',\r\n              properties: {\r\n                name: {\r\n                  type: 'string',\r\n                  description: 'Full name',\r\n                },\r\n                email: {\r\n                  type: 'string',\r\n                  description: 'Email address',\r\n                },\r\n                phone: {\r\n                  type: 'string',\r\n                  description: 'Phone number',\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      ],\r\n      tool_choice: 'auto',\r\n    });\r\n\r\n    const responseMessage = completion.choices[0]?.message;\r\n    const toolCalls = responseMessage?.tool_calls || [];\r\n\r\n    let propertyPreferences: PropertyPreferences = {};\r\n    let contactInfo: ContactInfo = {};\r\n    const extractedFields: string[] = [];\r\n    let confidence = 0.8; // Default confidence\r\n\r\n    // Process tool calls\r\n    for (const toolCall of toolCalls) {\r\n      const functionName = toolCall.function.name;\r\n      const args = JSON.parse(toolCall.function.arguments);\r\n\r\n      if (functionName === 'extract_property_preferences') {\r\n        propertyPreferences = PropertyPreferencesSchema.parse(args);\r\n        extractedFields.push(...Object.keys(args).filter(k => args[k] !== undefined && args[k] !== null));\r\n      } else if (functionName === 'extract_contact_info') {\r\n        contactInfo = ContactInfoSchema.parse(args);\r\n        extractedFields.push(...Object.keys(args).filter(k => args[k] !== undefined && args[k] !== null));\r\n      }\r\n    }\r\n\r\n    // Calculate confidence based on number of fields extracted\r\n    if (extractedFields.length > 0) {\r\n      confidence = Math.min(0.9, 0.6 + (extractedFields.length * 0.1));\r\n    }\r\n\r\n    return {\r\n      propertyPreferences,\r\n      contactInfo,\r\n      extractedFields: [...new Set(extractedFields)], // Deduplicate\r\n      confidence,\r\n    };\r\n  } catch (error) {\r\n    console.error('❌ Data extraction error:', error);\r\n\r\n    // Fallback to regex-based extraction if AI fails\r\n    return fallbackExtraction(userMessage);\r\n  }\r\n}\r\n\r\n/**\r\n * Fallback extraction using regex patterns (when AI extraction fails)\r\n */\r\nfunction fallbackExtraction(message: string): ExtractionResult {\r\n  const propertyPreferences: PropertyPreferences = {};\r\n  const contactInfo: ContactInfo = {};\r\n  const extractedFields: string[] = [];\r\n\r\n  // Extract price\r\n  const priceMatch = message.match(/\\$?([\\d,]+)k?(?:,000)?(?:\\s*(?:max|budget|price|under|up to))?/i);\r\n  if (priceMatch) {\r\n    let amount = parseInt(priceMatch[1].replace(/,/g, ''));\r\n    if (message.toLowerCase().includes('k') && amount < 10000) {\r\n      amount *= 1000;\r\n    }\r\n    propertyPreferences.maxPrice = amount;\r\n    extractedFields.push('maxPrice');\r\n  }\r\n\r\n  // Extract bedrooms\r\n  const bedroomsMatch = message.match(/(\\d+)\\s*(?:bed|br|bedroom)/i);\r\n  if (bedroomsMatch) {\r\n    propertyPreferences.minBedrooms = parseInt(bedroomsMatch[1]);\r\n    extractedFields.push('minBedrooms');\r\n  }\r\n\r\n  // Extract bathrooms\r\n  const bathroomsMatch = message.match(/(\\d+(?:\\.\\d+)?)\\s*(?:bath|ba|bathroom)/i);\r\n  if (bathroomsMatch) {\r\n    propertyPreferences.minBathrooms = parseFloat(bathroomsMatch[1]);\r\n    extractedFields.push('minBathrooms');\r\n  }\r\n\r\n  // Extract features\r\n  const features: string[] = [];\r\n  if (/\\bpool\\b/i.test(message)) features.push('pool');\r\n  if (/\\b(?:backyard|yard)\\b/i.test(message)) features.push('backyard');\r\n  if (/\\bgarage\\b/i.test(message)) features.push('garage');\r\n  if (/\\bfireplace\\b/i.test(message)) features.push('fireplace');\r\n  if (features.length > 0) {\r\n    propertyPreferences.mustHaveFeatures = features;\r\n    extractedFields.push('mustHaveFeatures');\r\n  }\r\n\r\n  // Extract property type\r\n  if (/\\b(?:single-family|house|home)\\b/i.test(message)) {\r\n    propertyPreferences.propertyType = 'single-family';\r\n    extractedFields.push('propertyType');\r\n  } else if (/\\bcondo\\b/i.test(message)) {\r\n    propertyPreferences.propertyType = 'condo';\r\n    extractedFields.push('propertyType');\r\n  } else if (/\\btownhouse\\b/i.test(message)) {\r\n    propertyPreferences.propertyType = 'townhouse';\r\n    extractedFields.push('propertyType');\r\n  }\r\n\r\n  // Extract email\r\n  const emailMatch = message.match(/[\\w.-]+@[\\w.-]+\\.\\w+/);\r\n  if (emailMatch) {\r\n    contactInfo.email = emailMatch[0];\r\n    extractedFields.push('email');\r\n  }\r\n\r\n  // Extract phone\r\n  const phoneMatch = message.match(/\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}/);\r\n  if (phoneMatch) {\r\n    contactInfo.phone = phoneMatch[0];\r\n    extractedFields.push('phone');\r\n  }\r\n\r\n  return {\r\n    propertyPreferences,\r\n    contactInfo,\r\n    extractedFields,\r\n    confidence: extractedFields.length > 0 ? 0.6 : 0.3,\r\n  };\r\n}\r\n\r\n/**\r\n * Merge extracted data with existing conversation state\r\n * Only updates fields that are newly extracted\r\n */\r\nexport function mergeExtractedData(\r\n  existing: PropertyPreferences,\r\n  extracted: PropertyPreferences\r\n): PropertyPreferences {\r\n  return {\r\n    ...existing,\r\n    ...Object.fromEntries(\r\n      Object.entries(extracted).filter(([_, value]) => value !== undefined && value !== null)\r\n    ),\r\n  };\r\n}\r\n\r\n/**\r\n * Check if we have minimum required data to search properties\r\n */\r\nexport function hasMinimumSearchCriteria(preferences: PropertyPreferences): boolean {\r\n  return !!(preferences.location && preferences.maxPrice);\r\n}\r\n\r\n/**\r\n * Get list of missing critical fields for property search\r\n */\r\nexport function getMissingCriticalFields(preferences: PropertyPreferences): string[] {\r\n  const missing: string[] = [];\r\n\r\n  if (!preferences.location) missing.push('location');\r\n  if (!preferences.maxPrice) missing.push('budget');\r\n\r\n  return missing;\r\n}\r\n\r\n/**\r\n * Format preferences for display (debugging)\r\n */\r\nexport function formatPreferences(preferences: PropertyPreferences): string {\r\n  const parts: string[] = [];\r\n\r\n  if (preferences.location) parts.push(`📍 ${preferences.location}`);\r\n  if (preferences.maxPrice) parts.push(`💰 $${preferences.maxPrice.toLocaleString()}`);\r\n  if (preferences.minBedrooms) parts.push(`🛏️ ${preferences.minBedrooms}+ bed`);\r\n  if (preferences.minBathrooms) parts.push(`🛁 ${preferences.minBathrooms}+ bath`);\r\n  if (preferences.propertyType) parts.push(`🏠 ${preferences.propertyType}`);\r\n  if (preferences.mustHaveFeatures && preferences.mustHaveFeatures.length > 0) {\r\n    parts.push(`✨ ${preferences.mustHaveFeatures.join(', ')}`);\r\n  }\r\n\r\n  return parts.join(' | ');\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2789, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/lib/services/crm-integration.ts"],"sourcesContent":["// lib/services/crm-integration.ts\r\nimport 'server-only';\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { PropertyPreferences, ContactInfo } from '@/lib/ai/data-extraction';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * Lead score calculation based on engagement and preferences\r\n */\r\nexport enum LeadScore {\r\n  COLD = 'COLD',\r\n  WARM = 'WARM',\r\n  HOT = 'HOT',\r\n  QUALIFIED = 'QUALIFIED',\r\n}\r\n\r\n/**\r\n * Calculate lead score based on conversation engagement\r\n */\r\nfunction calculateLeadScore(\r\n  messageCount: number,\r\n  hasContactInfo: boolean,\r\n  hasCompleteCriteria: boolean,\r\n  viewedProperties: number,\r\n  budget?: number\r\n): { score: LeadScore; scoreValue: number } {\r\n  let scoreValue = 0;\r\n\r\n  // Engagement points\r\n  scoreValue += messageCount * 5; // 5 points per message\r\n  if (hasContactInfo) scoreValue += 30; // Big boost for contact info\r\n  if (hasCompleteCriteria) scoreValue += 20; // Complete search criteria\r\n  scoreValue += viewedProperties * 10; // 10 points per property viewed\r\n\r\n  // Budget qualifier\r\n  if (budget && budget >= 500000) scoreValue += 15; // Higher budget = more serious\r\n\r\n  // Determine score tier\r\n  let score: LeadScore;\r\n  if (scoreValue >= 80 && hasContactInfo) {\r\n    score = LeadScore.QUALIFIED; // Ready for agent contact\r\n  } else if (scoreValue >= 50) {\r\n    score = LeadScore.HOT; // Very engaged\r\n  } else if (scoreValue >= 25) {\r\n    score = LeadScore.WARM; // Moderately engaged\r\n  } else {\r\n    score = LeadScore.COLD; // Just started\r\n  }\r\n\r\n  return { score, scoreValue };\r\n}\r\n\r\n/**\r\n * Determine lead status based on conversation stage\r\n */\r\nfunction determineLeadStatus(\r\n  canSearch: boolean,\r\n  hasSearched: boolean,\r\n  hasScheduledShowing: boolean\r\n): string {\r\n  if (hasScheduledShowing) return 'CONTACTED'; // Agent engaged\r\n  if (hasSearched) return 'QUALIFIED'; // Saw properties\r\n  if (canSearch) return 'WORKING'; // Has criteria, ready to search\r\n  return 'NEW_LEAD'; // Just started conversation\r\n}\r\n\r\n/**\r\n * Create or update lead in CRM from chatbot conversation\r\n */\r\nexport async function syncLeadToCRM(params: {\r\n  sessionId: string;\r\n  organizationId: string;\r\n  contactInfo?: ContactInfo;\r\n  propertyPreferences?: PropertyPreferences;\r\n  messageCount: number;\r\n  hasSearched?: boolean;\r\n  viewedProperties?: string[];\r\n  lastMessage: string;\r\n}): Promise<{ leadId: string; isNew: boolean }> {\r\n  const {\r\n    sessionId,\r\n    organizationId,\r\n    contactInfo,\r\n    propertyPreferences,\r\n    messageCount,\r\n    hasSearched = false,\r\n    viewedProperties = [],\r\n    lastMessage,\r\n  } = params;\r\n\r\n  try {\r\n    // Check if lead already exists for this session\r\n    const existingLead = await prisma.leads.findFirst({\r\n      where: {\r\n        organization_id: organizationId,\r\n        custom_fields: {\r\n          path: ['chatbot_session_id'],\r\n          equals: sessionId,\r\n        },\r\n      },\r\n    });\r\n\r\n    // Calculate lead score\r\n    const hasContactInfo = !!(contactInfo?.email || contactInfo?.phone || contactInfo?.name);\r\n    const hasCompleteCriteria = !!(propertyPreferences?.location && propertyPreferences?.maxPrice);\r\n    const { score, scoreValue } = calculateLeadScore(\r\n      messageCount,\r\n      hasContactInfo,\r\n      hasCompleteCriteria,\r\n      viewedProperties.length,\r\n      propertyPreferences?.maxPrice\r\n    );\r\n\r\n    // Determine status\r\n    const status = determineLeadStatus(hasCompleteCriteria, hasSearched, false);\r\n\r\n    // Build custom fields JSON\r\n    const customFields = {\r\n      chatbot_session_id: sessionId,\r\n      property_preferences: propertyPreferences ? {\r\n        location: propertyPreferences.location,\r\n        maxPrice: propertyPreferences.maxPrice,\r\n        minBedrooms: propertyPreferences.minBedrooms,\r\n        minBathrooms: propertyPreferences.minBathrooms,\r\n        mustHaveFeatures: propertyPreferences.mustHaveFeatures || [],\r\n        niceToHaveFeatures: propertyPreferences.niceToHaveFeatures || [],\r\n        propertyType: propertyPreferences.propertyType,\r\n        timeline: propertyPreferences.timeline,\r\n        isFirstTimeBuyer: propertyPreferences.isFirstTimeBuyer,\r\n        currentSituation: propertyPreferences.currentSituation,\r\n      } : undefined,\r\n      last_property_search: hasSearched ? new Date().toISOString() : undefined,\r\n      viewed_properties: viewedProperties,\r\n      chatbot_engagement: {\r\n        message_count: messageCount,\r\n        last_message: lastMessage,\r\n        last_interaction: new Date().toISOString(),\r\n      },\r\n    };\r\n\r\n    if (existingLead) {\r\n      // Update existing lead\r\n      const updatedLead = await prisma.leads.update({\r\n        where: { id: existingLead.id },\r\n        data: {\r\n          name: contactInfo?.name || existingLead.name,\r\n          email: contactInfo?.email || existingLead.email,\r\n          phone: contactInfo?.phone || existingLead.phone,\r\n          budget: propertyPreferences?.maxPrice ? propertyPreferences.maxPrice.toString() : existingLead.budget,\r\n          timeline: propertyPreferences?.timeline || existingLead.timeline,\r\n          score: score,\r\n          score_value: scoreValue,\r\n          status: status as any,\r\n          notes: `Last message: \"${lastMessage.slice(0, 200)}\"`,\r\n          custom_fields: customFields as any,\r\n          last_contact_at: new Date(),\r\n          updated_at: new Date(),\r\n        },\r\n      });\r\n\r\n      console.log(`✅ Updated lead ${updatedLead.id} (score: ${score}, status: ${status})`);\r\n\r\n      return { leadId: updatedLead.id, isNew: false };\r\n    } else {\r\n      // Create new lead\r\n      const newLead = await prisma.leads.create({\r\n        data: {\r\n          organization_id: organizationId,\r\n          name: contactInfo?.name || 'Chatbot Lead',\r\n          email: contactInfo?.email || undefined,\r\n          phone: contactInfo?.phone || undefined,\r\n          source: 'CHATBOT',\r\n          status: status as any,\r\n          score: score,\r\n          score_value: scoreValue,\r\n          budget: propertyPreferences?.maxPrice ? propertyPreferences.maxPrice.toString() : undefined,\r\n          timeline: propertyPreferences?.timeline,\r\n          notes: `First message: \"${lastMessage.slice(0, 200)}\"`,\r\n          tags: ['chatbot', 'real-estate'],\r\n          custom_fields: customFields as any,\r\n          last_contact_at: new Date(),\r\n        },\r\n      });\r\n\r\n      console.log(`✅ Created new lead ${newLead.id} (score: ${score}, status: ${status})`);\r\n\r\n      return { leadId: newLead.id, isNew: true };\r\n    }\r\n  } catch (error) {\r\n    console.error('❌ CRM sync error:', error);\r\n    throw new Error('Failed to sync lead to CRM');\r\n  }\r\n}\r\n\r\n/**\r\n * Log conversation activity to CRM\r\n */\r\nexport async function logActivity(params: {\r\n  organizationId: string;\r\n  leadId: string;\r\n  activityType: 'message' | 'property_view' | 'property_search' | 'showing_request';\r\n  description: string;\r\n  metadata?: Record<string, any>;\r\n}): Promise<void> {\r\n  const { organizationId, leadId, activityType, description, metadata } = params;\r\n\r\n  try {\r\n    // Find the lead to get assigned user\r\n    const lead = await prisma.leads.findUnique({\r\n      where: { id: leadId },\r\n      select: { assigned_to_id: true },\r\n    });\r\n\r\n    await prisma.activities.create({\r\n      data: {\r\n        organization_id: organizationId,\r\n        lead_id: leadId,\r\n        contact_id: undefined, // Chatbot leads are in leads table, not contacts\r\n        type: activityType === 'message' ? 'NOTE' : 'CALL', // Map to CRM activity types\r\n        title: `Chatbot: ${activityType}`,\r\n        description,\r\n        metadata: metadata as any,\r\n        completed_at: new Date(),\r\n        assigned_to_id: lead?.assigned_to_id || undefined,\r\n      },\r\n    });\r\n\r\n    console.log(`📝 Logged activity: ${activityType} for lead ${leadId}`);\r\n  } catch (error) {\r\n    console.error('❌ Activity logging error:', error);\r\n    // Don't throw - activity logging is non-critical\r\n  }\r\n}\r\n\r\n/**\r\n * Track property views for a lead\r\n */\r\nexport async function trackPropertyView(params: {\r\n  sessionId: string;\r\n  organizationId: string;\r\n  propertyId: string;\r\n  propertyAddress: string;\r\n}): Promise<void> {\r\n  const { sessionId, organizationId, propertyId, propertyAddress } = params;\r\n\r\n  try {\r\n    // Find lead by session\r\n    const lead = await prisma.leads.findFirst({\r\n      where: {\r\n        organization_id: organizationId,\r\n        custom_fields: {\r\n          path: ['chatbot_session_id'],\r\n          equals: sessionId,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!lead) {\r\n      console.warn('⚠️ No lead found for property view tracking');\r\n      return;\r\n    }\r\n\r\n    // Update viewed properties\r\n    const customFields = lead.custom_fields as any;\r\n    const viewedProperties = customFields?.viewed_properties || [];\r\n\r\n    if (!viewedProperties.includes(propertyId)) {\r\n      viewedProperties.push(propertyId);\r\n\r\n      await prisma.leads.update({\r\n        where: { id: lead.id },\r\n        data: {\r\n          custom_fields: {\r\n            ...customFields,\r\n            viewed_properties: viewedProperties,\r\n          } as any,\r\n        },\r\n      });\r\n\r\n      // Log activity\r\n      await logActivity({\r\n        organizationId,\r\n        leadId: lead.id,\r\n        activityType: 'property_view',\r\n        description: `Viewed property: ${propertyAddress}`,\r\n        metadata: { property_id: propertyId, property_address: propertyAddress },\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('❌ Property view tracking error:', error);\r\n    // Don't throw - tracking is non-critical\r\n  }\r\n}\r\n\r\n/**\r\n * Create showing appointment request\r\n */\r\nexport async function requestShowing(params: {\r\n  sessionId: string;\r\n  organizationId: string;\r\n  propertyId: string;\r\n  propertyAddress: string;\r\n  requestedDate?: Date;\r\n  requestedTime?: string;\r\n}): Promise<{ appointmentId: string }> {\r\n  const { sessionId, organizationId, propertyId, propertyAddress, requestedDate, requestedTime } = params;\r\n\r\n  try {\r\n    // Find lead by session\r\n    const lead = await prisma.leads.findFirst({\r\n      where: {\r\n        organization_id: organizationId,\r\n        custom_fields: {\r\n          path: ['chatbot_session_id'],\r\n          equals: sessionId,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!lead) {\r\n      throw new Error('Lead not found for showing request');\r\n    }\r\n\r\n    // Find or assign default agent\r\n    const assignedAgent = lead.assigned_to_id || await getDefaultAgent(organizationId);\r\n\r\n    if (!assignedAgent) {\r\n      throw new Error('No agent available for showing');\r\n    }\r\n\r\n    // Create appointment (showing request)\r\n    const appointment = await prisma.appointments.create({\r\n      data: {\r\n        organization_id: organizationId,\r\n        contact_id: undefined, // Link to lead via activity log instead\r\n        assigned_to: assignedAgent,\r\n        title: `Property Showing: ${propertyAddress}`,\r\n        description: `Chatbot showing request for property ${propertyId}\\nRequested by: ${lead.name || 'Unknown'}\\nEmail: ${lead.email || 'N/A'}\\nPhone: ${lead.phone || 'N/A'}`,\r\n        start_time: requestedDate || new Date(Date.now() + 24 * 60 * 60 * 1000), // Tomorrow by default\r\n        end_time: requestedDate ? new Date(requestedDate.getTime() + 60 * 60 * 1000) : new Date(Date.now() + 25 * 60 * 60 * 1000), // 1 hour duration\r\n        status: 'PENDING',\r\n        location: propertyAddress,\r\n      },\r\n    });\r\n\r\n    // Update lead status\r\n    await prisma.leads.update({\r\n      where: { id: lead.id },\r\n      data: {\r\n        status: 'CONTACTED',\r\n        score: LeadScore.QUALIFIED,\r\n      },\r\n    });\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      organizationId,\r\n      leadId: lead.id,\r\n      activityType: 'showing_request',\r\n      description: `Requested showing for ${propertyAddress}${requestedDate ? ` on ${requestedDate.toDateString()}` : ''}`,\r\n      metadata: {\r\n        property_id: propertyId,\r\n        property_address: propertyAddress,\r\n        appointment_id: appointment.id,\r\n      },\r\n    });\r\n\r\n    console.log(`📅 Created showing request ${appointment.id} for lead ${lead.id}`);\r\n\r\n    return { appointmentId: appointment.id };\r\n  } catch (error) {\r\n    console.error('❌ Showing request error:', error);\r\n    throw new Error('Failed to create showing request');\r\n  }\r\n}\r\n\r\n/**\r\n * Get default agent for organization (for auto-assignment)\r\n */\r\nasync function getDefaultAgent(organizationId: string): Promise<string | null> {\r\n  try {\r\n    // Find first active admin or employee\r\n    const user = await prisma.users.findFirst({\r\n      where: {\r\n        organization_id: organizationId,\r\n        role: {\r\n          in: ['ADMIN', 'EMPLOYEE'],\r\n        },\r\n      },\r\n      orderBy: { created_at: 'asc' },\r\n    });\r\n\r\n    return user?.id || null;\r\n  } catch (error) {\r\n    console.error('❌ Default agent lookup error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get lead summary for agent handoff\r\n */\r\nexport async function getLeadSummary(sessionId: string, organizationId: string): Promise<{\r\n  lead: any;\r\n  preferences: PropertyPreferences | null;\r\n  engagementMetrics: {\r\n    messageCount: number;\r\n    viewedProperties: number;\r\n    score: string;\r\n    status: string;\r\n  };\r\n}> {\r\n  try {\r\n    const lead = await prisma.leads.findFirst({\r\n      where: {\r\n        organization_id: organizationId,\r\n        custom_fields: {\r\n          path: ['chatbot_session_id'],\r\n          equals: sessionId,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!lead) {\r\n      throw new Error('Lead not found');\r\n    }\r\n\r\n    const customFields = lead.custom_fields as any;\r\n    const preferences = customFields?.property_preferences || null;\r\n    const engagement = customFields?.chatbot_engagement || {};\r\n    const viewedProperties = customFields?.viewed_properties || [];\r\n\r\n    return {\r\n      lead,\r\n      preferences,\r\n      engagementMetrics: {\r\n        messageCount: engagement.message_count || 0,\r\n        viewedProperties: viewedProperties.length,\r\n        score: lead.score,\r\n        status: lead.status,\r\n      },\r\n    };\r\n  } catch (error) {\r\n    console.error('❌ Lead summary error:', error);\r\n    throw new Error('Failed to get lead summary');\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3170, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garre/STRIVE/Strive-SaaS/%28chatbot%29/app/api/chat/route.ts"],"sourcesContent":["// app/api/chat/route.ts\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport Groq from 'groq-sdk/index.mjs';\r\nimport { z } from 'zod';\r\nimport { loadIndustryConfig } from '@/app/industries';\r\nimport { RAGService } from '@/app/services/rag-service';\r\nimport { RentCastService, PropertySearchParams } from '@/app/services/rentcast-service';\r\nimport { IndustryType } from '@/types/industry';\r\nimport { ChatRequestSchema } from '@/app/schemas/chat-request';\r\nimport {\r\n  extractDataFromMessage,\r\n  mergeExtractedData,\r\n  hasMinimumSearchCriteria,\r\n  formatPreferences,\r\n  PropertyPreferences,\r\n} from '@/lib/ai/data-extraction';\r\nimport {\r\n  syncLeadToCRM,\r\n  logActivity,\r\n  trackPropertyView,\r\n} from '@/lib/services/crm-integration';\r\n\r\nconst groq = new Groq({\r\n  apiKey: process.env.GROQ_API_KEY,\r\n});\r\n\r\n// Session state cache (in production, use Redis or database)\r\nconst sessionStateCache = new Map<string, PropertyPreferences>();\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    // Parse and validate request body\r\n    const body = await req.json();\r\n    const validated = ChatRequestSchema.parse(body);\r\n\r\n    const {\r\n      messages,\r\n      industry = 'strive',\r\n      sessionId,\r\n      organizationId = 'default_org', // TODO: Get from auth context\r\n    } = validated;\r\n\r\n    // Load industry configuration\r\n    const config = await loadIndustryConfig(industry as IndustryType);\r\n\r\n    // Get the latest user message\r\n    const latestUserMessage = messages[messages.length - 1];\r\n\r\n    // 🎯 PHASE 1: INTELLIGENT DATA EXTRACTION\r\n    console.log('🧠 Extracting data from user message...');\r\n    const extraction = await extractDataFromMessage(\r\n      latestUserMessage.content,\r\n      messages.slice(-5).map(m => ({ role: m.role as 'user' | 'assistant', content: m.content }))\r\n    );\r\n\r\n    console.log('✅ Extracted:', {\r\n      fields: extraction.extractedFields,\r\n      confidence: extraction.confidence,\r\n      preferences: formatPreferences(extraction.propertyPreferences),\r\n    });\r\n\r\n    // Get or initialize session state\r\n    let sessionPreferences = sessionStateCache.get(sessionId) || {};\r\n\r\n    // Merge extracted data with existing session state\r\n    sessionPreferences = mergeExtractedData(sessionPreferences, extraction.propertyPreferences);\r\n    sessionStateCache.set(sessionId, sessionPreferences);\r\n\r\n    console.log('💾 Current session state:', formatPreferences(sessionPreferences));\r\n\r\n    // Check if we can search now\r\n    const canSearchNow = hasMinimumSearchCriteria(sessionPreferences);\r\n    console.log('🔍 Can search:', canSearchNow);\r\n\r\n    // Build conversation history context\r\n    const conversationHistory = {\r\n      stage: determineConversationStage(messages as unknown as Message[]),\r\n      messageCount: messages.length,\r\n      problemsDiscussed: extractProblemsDiscussed(messages as unknown as Message[]),\r\n      currentPreferences: sessionPreferences,\r\n      extractedThisMessage: extraction.extractedFields,\r\n      canSearch: canSearchNow,\r\n    };\r\n\r\n    // 🔥 RAG ENHANCEMENT: Get semantic context\r\n    console.log('🔍 Searching for similar conversations...');\r\n    const ragContext = await RAGService.buildRAGContext(\r\n      latestUserMessage.content,\r\n      industry,\r\n      conversationHistory\r\n    );\r\n\r\n    console.log('✅ RAG Context:', {\r\n      detectedProblems: ragContext.searchResults.detectedProblems,\r\n      confidence: ragContext.searchResults.confidence.overallConfidence,\r\n      suggestedApproach: ragContext.guidance.suggestedApproach,\r\n    });\r\n\r\n    // Build enhanced system prompt with RAG context AND extracted data\r\n    const enhancedSystemPrompt = buildEnhancedSystemPrompt(\r\n      config.systemPrompt,\r\n      ragContext,\r\n      sessionPreferences,\r\n      extraction.extractedFields,\r\n      canSearchNow\r\n    );\r\n\r\n    // Prepare messages for Groq\r\n    const groqMessages = [\r\n      {\r\n        role: 'system' as const,\r\n        content: enhancedSystemPrompt,\r\n      },\r\n      ...messages\r\n        .filter(m => m.role !== 'system')\r\n        .map(m => ({\r\n          role: m.role as 'user' | 'assistant',\r\n          content: m.content,\r\n        })),\r\n    ];\r\n\r\n    // Stream response from Groq\r\n    const stream = await groq.chat.completions.create({\r\n      model: 'llama-3.3-70b-versatile',\r\n      messages: groqMessages,\r\n      temperature: 0.7,\r\n      max_tokens: 2000, // Increased for property results\r\n      stream: true,\r\n    });\r\n\r\n    // Create readable stream\r\n    const encoder = new TextEncoder();\r\n    let fullResponse = '';\r\n\r\n    const readableStream = new ReadableStream({\r\n      async start(controller) {\r\n        try {\r\n          // Stream LLM response\r\n          for await (const chunk of stream) {\r\n            const content = chunk.choices[0]?.delta?.content || '';\r\n            fullResponse += content;\r\n            \r\n            controller.enqueue(\r\n              encoder.encode(`data: ${JSON.stringify({ content })}\\n\\n`)\r\n            );\r\n          }\r\n\r\n          // 🏠 PROPERTY SEARCH: Check if response contains property search request OR if we can auto-search\r\n          const shouldSearch = industry === 'real-estate' && (\r\n            fullResponse.includes('<property_search>') || canSearchNow\r\n          );\r\n\r\n          if (shouldSearch) {\r\n            try {\r\n              console.log('🏠 Property search triggered');\r\n\r\n              let searchParams: PropertySearchParams;\r\n\r\n              // Check if AI provided explicit search parameters\r\n              const searchMatch = fullResponse.match(/<property_search>([\\s\\S]*?)<\\/property_search>/);\r\n\r\n              if (searchMatch) {\r\n                // AI provided explicit search params\r\n                searchParams = JSON.parse(searchMatch[1]);\r\n                console.log('🔍 Using AI-provided search params:', searchParams);\r\n              } else if (canSearchNow) {\r\n                // Auto-search using extracted session state\r\n                searchParams = {\r\n                  location: sessionPreferences.location!,\r\n                  maxPrice: sessionPreferences.maxPrice!,\r\n                  minBedrooms: sessionPreferences.minBedrooms || 2, // Default: 2+ beds\r\n                  minBathrooms: sessionPreferences.minBathrooms || 1, // Default: 1+ baths\r\n                  mustHaveFeatures: sessionPreferences.mustHaveFeatures || [],\r\n                  niceToHaveFeatures: sessionPreferences.niceToHaveFeatures,\r\n                  propertyType: sessionPreferences.propertyType === 'any' ? undefined : sessionPreferences.propertyType,\r\n                };\r\n                console.log('🔍 Auto-searching with extracted params:', searchParams);\r\n              } else {\r\n                // Skip search\r\n                throw new Error('Cannot search: minimum criteria not met');\r\n              }\r\n\r\n              // Fetch properties from RentCast\r\n              const properties = await RentCastService.searchProperties(searchParams);\r\n              console.log(`✅ Found ${properties.length} properties`);\r\n\r\n              // Match and score properties\r\n              const matches = RentCastService.matchProperties(properties, searchParams);\r\n              console.log(`🎯 Top ${matches.length} matches selected`);\r\n\r\n              // Send property results to client\r\n              const propertyData = JSON.stringify({\r\n                type: 'property_results',\r\n                properties: matches,\r\n              });\r\n              controller.enqueue(encoder.encode(`data: ${propertyData}\\n\\n`));\r\n            } catch (propertyError) {\r\n              console.error('❌ Property search error:', propertyError);\r\n              const errorData = JSON.stringify({\r\n                type: 'property_search_error',\r\n                error: 'Failed to search properties. Please try again.',\r\n              });\r\n              controller.enqueue(encoder.encode(`data: ${errorData}\\n\\n`));\r\n            }\r\n          }\r\n\r\n          // 🔥 STORE CONVERSATION: Save for future learning\r\n          console.log('💾 Storing conversation for learning...');\r\n          await RAGService.storeConversation({\r\n            industry,\r\n            sessionId,\r\n            userMessage: latestUserMessage.content,\r\n            assistantResponse: fullResponse,\r\n            conversationStage: conversationHistory.stage,\r\n            outcome: 'in_progress',\r\n            bookingCompleted: false,\r\n            problemDetected: ragContext.searchResults.detectedProblems[0],\r\n            solutionPresented: ragContext.searchResults.recommendedSolutions[0],\r\n          });\r\n\r\n          // 💼 CRM INTEGRATION: Sync lead to platform CRM\r\n          if (industry === 'real-estate') {\r\n            try {\r\n              console.log('💼 Syncing lead to CRM...');\r\n\r\n              const { leadId, isNew } = await syncLeadToCRM({\r\n                sessionId,\r\n                organizationId,\r\n                contactInfo: extraction.contactInfo,\r\n                propertyPreferences: sessionPreferences,\r\n                messageCount: messages.length,\r\n                hasSearched: shouldSearch,\r\n                viewedProperties: [], // Updated via separate tracking\r\n                lastMessage: latestUserMessage.content,\r\n              });\r\n\r\n              console.log(`✅ ${isNew ? 'Created' : 'Updated'} lead ${leadId} in CRM`);\r\n\r\n              // Log conversation activity\r\n              await logActivity({\r\n                organizationId,\r\n                leadId,\r\n                activityType: 'message',\r\n                description: `Chatbot conversation: \"${latestUserMessage.content.slice(0, 100)}...\"`,\r\n                metadata: {\r\n                  extracted_fields: extraction.extractedFields,\r\n                  can_search: canSearchNow,\r\n                  preferences: sessionPreferences,\r\n                },\r\n              });\r\n\r\n              // Log property search activity if triggered\r\n              if (shouldSearch) {\r\n                await logActivity({\r\n                  organizationId,\r\n                  leadId,\r\n                  activityType: 'property_search',\r\n                  description: `Searched properties in ${sessionPreferences.location} under $${sessionPreferences.maxPrice?.toLocaleString()}`,\r\n                  metadata: {\r\n                    search_params: sessionPreferences,\r\n                  },\r\n                });\r\n              }\r\n            } catch (crmError) {\r\n              console.error('❌ CRM sync error (non-critical):', crmError);\r\n              // Don't fail the request if CRM sync fails\r\n            }\r\n          }\r\n\r\n          // Send completion signal\r\n          controller.enqueue(encoder.encode('data: [DONE]\\n\\n'));\r\n          controller.close();\r\n        } catch (error) {\r\n          console.error('❌ Streaming error:', error);\r\n          controller.error(error);\r\n        }\r\n      },\r\n    });\r\n\r\n    return new NextResponse(readableStream, {\r\n      headers: {\r\n        'Content-Type': 'text/event-stream',\r\n        'Cache-Control': 'no-cache',\r\n        Connection: 'keep-alive',\r\n      },\r\n    });\r\n  } catch (error) {\r\n    // Handle validation errors\r\n    if (error instanceof z.ZodError) {\r\n      return NextResponse.json(\r\n        {\r\n          error: 'Invalid request format',\r\n          details: error.issues.map((e: z.ZodIssue) => ({\r\n            path: e.path.join('.'),\r\n            message: e.message\r\n          }))\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Handle other errors\r\n    console.error('❌ Chat API error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Build enhanced system prompt with RAG context AND conversation state\r\n */\r\nfunction buildEnhancedSystemPrompt(\r\n  basePrompt: string,\r\n  ragContext: RAGContext,\r\n  sessionPreferences: PropertyPreferences,\r\n  extractedFields: string[],\r\n  canSearch: boolean\r\n): string {\r\n  const { searchResults, guidance } = ragContext;\r\n\r\n  let enhancement = '\\n\\n## 🎯 CONTEXTUAL INTELLIGENCE\\n\\n';\r\n\r\n  // Add conversation state awareness\r\n  enhancement += `### 📊 Current Conversation State:\\n\\n`;\r\n\r\n  if (Object.keys(sessionPreferences).length > 0) {\r\n    enhancement += `**Information Already Collected:**\\n`;\r\n    if (sessionPreferences.location) enhancement += `- 📍 Location: ${sessionPreferences.location}\\n`;\r\n    if (sessionPreferences.maxPrice) enhancement += `- 💰 Budget: $${sessionPreferences.maxPrice.toLocaleString()}\\n`;\r\n    if (sessionPreferences.minBedrooms) enhancement += `- 🛏️ Bedrooms: ${sessionPreferences.minBedrooms}+\\n`;\r\n    if (sessionPreferences.minBathrooms) enhancement += `- 🛁 Bathrooms: ${sessionPreferences.minBathrooms}+\\n`;\r\n    if (sessionPreferences.propertyType) enhancement += `- 🏠 Type: ${sessionPreferences.propertyType}\\n`;\r\n    if (sessionPreferences.mustHaveFeatures && sessionPreferences.mustHaveFeatures.length > 0) {\r\n      enhancement += `- ✨ Must-have features: ${sessionPreferences.mustHaveFeatures.join(', ')}\\n`;\r\n    }\r\n    enhancement += '\\n';\r\n  }\r\n\r\n  if (extractedFields.length > 0) {\r\n    enhancement += `**Just Extracted from Last Message:** ${extractedFields.join(', ')}\\n\\n`;\r\n  }\r\n\r\n  // Search readiness\r\n  if (canSearch) {\r\n    enhancement += `🚀 **READY TO SEARCH!** You have location + budget. You can trigger a property search NOW by outputting the <property_search> format!\\n\\n`;\r\n  } else {\r\n    const missing: string[] = [];\r\n    if (!sessionPreferences.location) missing.push('location');\r\n    if (!sessionPreferences.maxPrice) missing.push('budget');\r\n    if (missing.length > 0) {\r\n      enhancement += `❌ **Cannot search yet.** Missing: ${missing.join(', ')}\\n`;\r\n      enhancement += `Ask for these naturally in your next response!\\n\\n`;\r\n    }\r\n  }\r\n\r\n  // RAG-Enhanced Guidance\r\n  if (searchResults.detectedProblems.length > 0) {\r\n    enhancement += `### 💡 Similar Conversations:\\n`;\r\n    searchResults.detectedProblems.forEach((problem: string) => {\r\n      enhancement += `- ${problem}\\n`;\r\n    });\r\n    enhancement += '\\n';\r\n  }\r\n\r\n  if (guidance.suggestedApproach) {\r\n    enhancement += `### 🎯 Recommended Approach:\\n${guidance.suggestedApproach}\\n\\n`;\r\n  }\r\n\r\n  enhancement += `**REMEMBER:** Don't ask for information you already have! Reference it naturally instead.\\n`;\r\n  enhancement += `**REMEMBER:** If you can search now, do it! Don't keep asking unnecessary questions.\\n`;\r\n\r\n  return basePrompt + enhancement;\r\n}\r\n\r\n/**\r\n * Determine current conversation stage\r\n */\r\nfunction determineConversationStage(messages: Message[]): string {\r\n  const userMessages = messages.filter(m => m.role === 'user');\r\n  \r\n  if (userMessages.length <= 2) return 'discovery';\r\n  if (userMessages.length <= 4) return 'qualifying';\r\n  if (userMessages.length <= 6) return 'solutioning';\r\n  \r\n  return 'closing';\r\n}\r\n\r\n/**\r\n * Extract problems discussed so far\r\n */\r\nfunction extractProblemsDiscussed(messages: Message[]): string[] {\r\n  const problems: string[] = [];\r\n  const problemKeywords = [\r\n    'losing customers',\r\n    'churn',\r\n    'defects',\r\n    'quality',\r\n    'support tickets',\r\n    'fraud',\r\n    'maintenance',\r\n    'inventory',\r\n    // Real estate specific\r\n    'looking for',\r\n    'buy',\r\n    'sell',\r\n    'property',\r\n    'home',\r\n    'budget',\r\n    'prequalified',\r\n    'market',\r\n  ];\r\n\r\n  messages.forEach(message => {\r\n    const content = message.content.toLowerCase();\r\n    problemKeywords.forEach(keyword => {\r\n      if (content.includes(keyword) && !problems.includes(keyword)) {\r\n        problems.push(keyword);\r\n      }\r\n    });\r\n  });\r\n\r\n  return problems;\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}