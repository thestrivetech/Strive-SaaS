# Schema Improvement Guide - Hybrid Approach

**Goal:** Create optimal schema combining NEW (snake_case) + OLD (auto-generation) strengths
**Time:** 30 minutes
**Status:** Ready to Execute

---

## 🎯 What We're Doing

**Current Issues:**
- ❌ No `@default(cuid())` on IDs → Manual ID generation required
- ❌ No `@updatedAt` on updated_at → Manual timestamp updates
- ❌ Missing `organization_tool_configs` model → Can't track tool marketplace

**Fix:** Restore auto-generation features while keeping snake_case naming

---

## 📋 Step-by-Step Process

### Step 1: Backup Current Schema (2 min)
```bash
cd shared/prisma
cp schema.prisma schema.prisma.current
```

### Step 2: Edit Schema - Add Auto Defaults (15 min)

**File:** `shared/prisma/schema.prisma`

#### A. Add `@default(cuid())` to ALL model IDs

Find and replace pattern:
```prisma
# FIND:
id String @id

# REPLACE WITH:
id String @id @default(cuid())
```

**Models to update (23 total):**
- users, organizations, organization_members, customers, projects, tasks
- notifications, appointments, attachments, content, conversations
- subscriptions, usage_tracking, activity_logs, ai_conversations, ai_tools
- analytics_events, analytics_goals, goal_conversions, page_views
- user_sessions, web_vitals_metrics

**Exception:** `example_conversations` already has `@default(dbgenerated(...))`

#### B. Add `@updatedAt` to ALL updated_at fields

Find and replace pattern:
```prisma
# FIND:
updated_at DateTime

# REPLACE WITH:
updated_at DateTime @updatedAt
```

**Apply to ALL models that have updated_at field**

#### C. Add Missing Model: organization_tool_configs

Add this model after `organization_members`:

```prisma
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model organization_tool_configs {
  id              String        @id @default(cuid())
  organization_id String
  tool_id         String
  industry        Industry
  enabled         Boolean       @default(false)
  settings        Json          @default("{}")
  enabled_at      DateTime?
  disabled_at     DateTime?
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, tool_id])
  @@index([organization_id, enabled])
  @@index([industry])
  @@index([tool_id])
}
```

#### D. Update organizations model to include relation

In `model organizations`, add to relations list:
```prisma
organization_tool_configs organization_tool_configs[]
```

### Step 3: Create Migration (5 min)

```bash
cd "(platform)"

# Generate migration
npx prisma migrate dev --name add-auto-defaults-and-tool-configs --schema=../shared/prisma/schema.prisma

# If migration fails due to existing data:
# Option 1: Reset dev database (ONLY if safe)
npx prisma migrate reset --schema=../shared/prisma/schema.prisma

# Option 2: Handle manually (production approach)
# - Migration will add defaults going forward
# - Existing records without UUIDs stay as-is
# - New records get auto-generated IDs
```

### Step 4: Generate Prisma Client (2 min)

```bash
npx prisma generate --schema=../shared/prisma/schema.prisma
```

### Step 5: Update Test Helpers (5 min)

**File:** `(platform)/__tests__/utils/test-helpers.ts`

**Remove manual ID generation** since Prisma will auto-generate:

```typescript
// BEFORE:
return await testPrisma.users.create({
  data: {
    id: `user-${Date.now()}`,  // ← REMOVE THIS LINE
    email: overrides.email || `test-${Date.now()}@example.com`,
    // ...
  },
});

// AFTER:
return await testPrisma.users.create({
  data: {
    // id auto-generated by Prisma!
    email: overrides.email || `test-${Date.now()}@example.com`,
    // ...
  },
});
```

**Apply to:**
- `createTestUser()` - remove id
- `createTestOrganization()` - remove id
- `createTestCustomer()` - remove id (if exists)
- Any other create functions with manual IDs

**Keep manual IDs only for:**
- Tests that specifically test ID handling
- Fixtures with known IDs for assertions

### Step 6: Update Completed Test Files (3 min)

**Files we fixed today - remove manual ID generation:**

1. `__tests__/unit/lib/modules/notifications/actions.test.ts`
   - Remove `id:` from all `create()` calls
   - Keep other fields

2. `__tests__/database/tenant-isolation.test.ts`
   - Remove `id:` from customer create

3. `__tests__/integration/crm-workflow.test.ts` (if has manual IDs)

**Pattern:**
```typescript
// BEFORE:
await testPrisma.notifications.create({
  data: {
    id: `notif-${Date.now()}-1`,        // ← REMOVE
    user_id: user.id,
    organization_id: organization.id,
    updated_at: new Date(),              // ← CAN ALSO REMOVE (@updatedAt handles it)
    // ...
  }
});

// AFTER:
await testPrisma.notifications.create({
  data: {
    // id auto-generated!
    user_id: user.id,
    organization_id: organization.id,
    // updated_at auto-set!
    // ...
  }
});
```

### Step 7: Verify (3 min)

```bash
# Check schema is valid
npx prisma validate --schema=../shared/prisma/schema.prisma

# Count auto-defaults (should be 23 for IDs, ~20 for @updatedAt)
grep "@default(cuid())" ../shared/prisma/schema.prisma | wc -l

# Check tool configs model exists
grep "organization_tool_configs" ../shared/prisma/schema.prisma

# Run type check
npx tsc --noEmit 2>&1 | grep -E "error TS" | wc -l
```

---

## ✅ Success Criteria

After completion, your schema should have:
- ✅ All IDs auto-generate with `@default(cuid())`
- ✅ All updated_at fields auto-update with `@updatedAt`
- ✅ `organization_tool_configs` model exists
- ✅ Prisma client regenerated
- ✅ Tests simplified (no manual ID/timestamp management)
- ✅ Type check errors same or reduced

---

## 🔧 Troubleshooting

### Migration Fails - "Column has null values"

**Problem:** Existing records have NULL in updated_at

**Solution:**
```sql
-- Run this before migration
UPDATE users SET updated_at = created_at WHERE updated_at IS NULL;
UPDATE organizations SET updated_at = created_at WHERE updated_at IS NULL;
-- Repeat for all tables
```

### Type Errors Increase After Migration

**Likely Cause:** Prisma client not regenerated

**Solution:**
```bash
npx prisma generate --schema=../shared/prisma/schema.prisma
# Restart TypeScript server in IDE
```

### Tests Fail - "Field required"

**Problem:** Old tests still passing `id` or `updated_at`

**Solution:** Remove these fields from test data objects

---

## 📊 Impact Summary

**Before:**
- Manual ID generation in 100+ places
- Manual timestamp updates
- Missing tool marketplace model
- Error-prone creates

**After:**
- Automatic ID generation (database handles)
- Automatic timestamp updates (Prisma handles)
- Tool marketplace ready
- Simpler, more reliable code

**Code Simplification Example:**
```typescript
// BEFORE (error-prone):
await prisma.users.create({
  data: {
    id: `user-${Date.now()}-${Math.random()}`,
    email: 'test@example.com',
    updated_at: new Date(),
    // Easy to forget id or updated_at
  }
});

// AFTER (bulletproof):
await prisma.users.create({
  data: {
    email: 'test@example.com',
    // That's it! id and updated_at handled automatically
  }
});
```

---

## 🔗 Next Steps After Schema Improvement

1. Continue with Session 5 error fixes (now easier with auto-generation)
2. All new creates won't need manual IDs
3. Module fixes will be simpler
4. Estimated error reduction: -20 to -30 errors from simplified creates

---

**Last Updated:** 2025-10-04
**Estimated Time:** 30 minutes
**Required:** Before continuing module error fixes
